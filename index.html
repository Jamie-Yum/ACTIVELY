<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ACTIVELY â€” ì‹¤ì‹œê°„ ì²­ì¤‘ ì°¸ì—¬ í”Œë«í¼</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<!-- âœ… Firebase SDK (v9 compat mode) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
// ============================================================
//  ğŸ”¥ FIREBASE ì„¤ì •
//  Firebase ì½˜ì†”(console.firebase.google.com)ì—ì„œ
//  í”„ë¡œì íŠ¸ ìƒì„± í›„ ì•„ë˜ ê°’ì„ êµì²´í•˜ì„¸ìš”.
//  ìì„¸í•œ ë°©ë²•: ì•„ë˜ SETUP_GUIDE.md íŒŒì¼ ì°¸ê³ 
// ============================================================
const FIREBASE_CONFIG = {
   apiKey: "AIzaSyARGGo-suJzirH05rzHBoaAnuFwJ9ktqBI",
  authDomain: "actively-9933.firebaseapp.com",
  databaseURL: "https://actively-9933-default-rtdb.firebaseio.com",
  projectId: "actively-9933",
  storageBucket: "actively-9933.firebasestorage.app",
  messagingSenderId: "168605815360",
  appId: "1:168605815360:web:cb9ab26ccad9acf22a85a5",
  measurementId: "G-VSJ273RTNC"
};


// ì„¤ì •ì´ ì™„ë£ŒëëŠ”ì§€ ì²´í¬
const FIREBASE_READY = !FIREBASE_CONFIG.apiKey.includes('YOUR_');

if (FIREBASE_READY) {
  const firebaseConfig = {
  apiKey: "AIzaSyARGGo-suJzirH05rzHBoaAnuFwJ9ktqBI",
  authDomain: "actively-9933.firebaseapp.com",
  databaseURL: "https://actively-9933-default-rtdb.firebaseio.com",
  projectId: "actively-9933",
  storageBucket: "actively-9933.firebasestorage.app",
  messagingSenderId: "168605815360",
  appId: "1:168605815360:web:cb9ab26ccad9acf22a85a5",
  measurementId: "G-VSJ273RTNC"
};

firebase.initializeApp(FIREBASE_CONFIG);
}
</script>
<style>
/* ============================================================
   ROOT & RESET
============================================================ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

/* ============================================================
   UI MODE SYSTEM  (light / dark / vivid)
   All surface/text/border tokens are overridden per mode.
============================================================ */

/* â”€â”€ DEFAULT: Light â”€â”€ */
:root {
  --font: 'Noto Sans KR', sans-serif;

  /* surfaces */
  --white:   #ffffff;
  --off:     #f7f6f3;
  --off2:    #eeece8;
  --surface-card: #ffffff;
  --surface-nav:  #ffffff;
  --surface-sidebar: #ffffff;

  /* borders */
  --border:  #e2dfd8;
  --border2: #d4d0c8;

  /* text */
  --text:    #1a1916;
  --muted:   #7a7670;
  --muted2:  #b0ada6;

  /* hero */
  --hero-bg: #1a1916;
  --hero-text: #ffffff;

  /* context accent colours (unchanged across modes) */
  --edu-h: #1a3a2e; --edu-a: #2d7a5a; --edu-l: #e8f5ee; --edu-g: linear-gradient(135deg,#2d7a5a,#1a5c42);
  --biz-h: #1a1f3a; --biz-a: #2b4bbf; --biz-l: #eef1fb; --biz-g: linear-gradient(135deg,#2b4bbf,#1a3080);
  --evt-h: #3a1a2e; --evt-a: #c2337a; --evt-l: #fbeef5; --evt-g: linear-gradient(135deg,#c2337a,#8b1d57);

  --r: 14px; --r-sm: 8px;

  /* active context theme */
  --theme-h: var(--edu-h);
  --theme-a: var(--edu-a);
  --theme-l: var(--edu-l);
  --theme-g: var(--edu-g);
}

/* â”€â”€ DARK mode â”€â”€ */
body.ui-dark {
  --white:   #1a1a24;
  --off:     #13131c;
  --off2:    #1f1f2e;
  --surface-card: #1f1f2e;
  --surface-nav:  #13131c;
  --surface-sidebar: #13131c;
  --border:  rgba(255,255,255,0.09);
  --border2: rgba(255,255,255,0.15);
  --text:    #e8e8f0;
  --muted:   #7a7a9a;
  --muted2:  #4a4a6a;
  --hero-bg: #0d0d16;
  --hero-text: #e8e8f0;

  /* in dark mode, context "light" bg becomes semi-transparent dark tint */
  --edu-l: rgba(45,122,90,0.15);
  --biz-l: rgba(43,75,191,0.15);
  --evt-l: rgba(194,51,122,0.15);
}

/* â”€â”€ VIVID mode â”€â”€ */
body.ui-vivid {
  --white:   #fffdf9;
  --off:     #fff8f0;
  --off2:    #ffeedd;
  --surface-card: #fffdf9;
  --surface-nav:  #fffdf9;
  --surface-sidebar: #fffdf9;
  --border:  #f0d8c0;
  --border2: #e8c8a8;
  --text:    #1a1200;
  --muted:   #886644;
  --muted2:  #cc9966;
  --hero-bg: linear-gradient(135deg, #ff6b35 0%, #f72585 40%, #7209b7 100%);
  --hero-text: #ffffff;
  --edu-a: #00b894; --edu-l: #e0fff8; --edu-g: linear-gradient(135deg,#00b894,#00796b);
  --biz-a: #6c5ce7; --biz-l: #ede7ff; --biz-g: linear-gradient(135deg,#6c5ce7,#4a00b4);
  --evt-a: #fd79a8; --evt-l: #fff0f7; --evt-g: linear-gradient(135deg,#fd79a8,#e84393);
}

/* Smooth transitions when switching modes */
body { transition: background 0.3s, color 0.3s; }
.card, .left-panel, .right-panel, .host-nav, .main-center,
.stat-box, .act-btn, .template-item, .qa-card, .feed-item,
.form-input, .wc-canvas, .qr-box, .v-btn, .q-opt, .nav-tab { transition: background 0.3s, border-color 0.3s, color 0.3s; }

body {
  font-family: var(--font);
  background: var(--off);
  color: var(--text);
  min-height: 100vh;
  font-size: 15px;
  line-height: 1.5;
}

button { font-family: inherit; cursor: pointer; }
input, textarea { font-family: inherit; }

/* â”€â”€ UI MODE SWITCHER WIDGET â”€â”€ */
.ui-switcher {
  display: flex;
  align-items: center;
  gap: 4px;
  background: var(--off2);
  border: 1px solid var(--border);
  border-radius: 100px;
  padding: 3px;
}
.ui-sw-btn {
  width: 28px; height: 28px;
  border-radius: 100px;
  border: none;
  background: transparent;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px;
  transition: all 0.15s;
  position: relative;
}
.ui-sw-btn:hover { transform: scale(1.15); }
.ui-sw-btn.active {
  background: var(--surface-card);
  box-shadow: 0 1px 4px rgba(0,0,0,0.18);
}
.ui-sw-btn[title]::after {
  content: attr(title);
  position: absolute;
  bottom: -26px; left: 50%;
  transform: translateX(-50%);
  background: var(--text);
  color: var(--off);
  font-size: 10px;
  padding: 2px 7px;
  border-radius: 4px;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s;
  font-family: var(--font);
}
.ui-sw-btn:hover[title]::after { opacity: 1; }

/* ============================================================
   SCREEN ROUTER
============================================================ */
.screen { display: none; min-height: 100vh; }
.screen.active { display: flex; flex-direction: column; }

/* ============================================================
   LANDING SCREEN
============================================================ */
#screen-landing {
  background: var(--surface-card);
  align-items: stretch;
}

.landing-hero {
  background: var(--hero-bg);
  color: var(--hero-text);
  padding: 64px 60px 56px;
  position: relative;
  overflow: hidden;
}

.landing-hero::before {
  content: '';
  position: absolute;
  width: 600px; height: 600px;
  border-radius: 50%;
  background: rgba(255,255,255,0.03);
  top: -200px; right: -100px;
  pointer-events: none;
}

.landing-hero::after {
  content: '';
  position: absolute;
  width: 400px; height: 400px;
  border-radius: 50%;
  background: rgba(255,255,255,0.03);
  bottom: -150px; left: 20%;
  pointer-events: none;
}

.hero-eyebrow {
  font-size: 11px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: rgba(255,255,255,0.5);
  margin-bottom: 20px;
}

.hero-title {
  font-family: var(--font); font-weight: 800;
  font-size: clamp(38px, 5vw, 64px);
  line-height: 1.1;
  margin-bottom: 20px;
  max-width: 600px;
  color: #ffffff;
}

.hero-title em {
  font-style: normal;
  opacity: 0.6;
}

.hero-sub {
  font-size: 16px;
  color: rgba(255,255,255,0.55);
  max-width: 460px;
  line-height: 1.7;
  margin-bottom: 40px;
}

.hero-actions { display: flex; gap: 12px; flex-wrap: wrap; }

.btn-hero-primary {
  background: var(--white);
  color: var(--text);
  border: none;
  padding: 14px 28px;
  border-radius: 100px;
  font-size: 14px; font-weight: 600;
  letter-spacing: -0.2px;
  transition: all 0.2s;
}
.btn-hero-primary:hover { background: var(--off2); transform: translateY(-1px); }

.btn-hero-secondary {
  background: transparent;
  color: rgba(255,255,255,0.6);
  border: 1px solid rgba(255,255,255,0.2);
  padding: 14px 28px;
  border-radius: 100px;
  font-size: 14px; font-weight: 500;
  transition: all 0.2s;
}
.btn-hero-secondary:hover { border-color: rgba(255,255,255,0.5); color: var(--white); }

.landing-body { padding: 56px 60px; flex: 1; }

.section-label {
  font-size: 11px; font-weight: 600;
  letter-spacing: 2px; text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 24px;
}

.context-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-bottom: 56px;
}

.ctx-card {
  background: var(--off);
  border: 2px solid var(--border);
  border-radius: 20px;
  padding: 28px;
  cursor: pointer;
  transition: all 0.25s;
  position: relative;
  overflow: hidden;
}

.ctx-card::before {
  content: '';
  position: absolute;
  inset: 0;
  opacity: 0;
  transition: opacity 0.25s;
}

.ctx-card.edu::before { background: var(--edu-l); }
.ctx-card.biz::before { background: var(--biz-l); }
.ctx-card.evt::before { background: var(--evt-l); }

.ctx-card:hover { border-color: transparent; transform: translateY(-3px); box-shadow: 0 12px 40px rgba(0,0,0,0.08); }
.ctx-card:hover::before { opacity: 1; }
.ctx-card:hover .ctx-icon { transform: scale(1.1); }

.ctx-card > * { position: relative; z-index: 1; }

.ctx-icon {
  font-size: 36px;
  margin-bottom: 16px;
  display: block;
  transition: transform 0.25s;
  line-height: 1;
}

.ctx-title {
  font-family: var(--font); font-weight: 700;
  font-size: 22px;
  margin-bottom: 6px;
}

.ctx-desc { font-size: 13px; color: var(--muted); line-height: 1.5; margin-bottom: 16px; }

.ctx-tags { display: flex; flex-wrap: wrap; gap: 6px; }

.ctx-tag {
  font-size: 10px; font-weight: 600;
  letter-spacing: 0.5px; text-transform: uppercase;
  padding: 4px 10px;
  border-radius: 100px;
  background: var(--off2);
  color: var(--muted);
  border: 1px solid var(--border);
}

.ctx-card.edu:hover .ctx-tag { background: rgba(45,122,90,0.1); color: var(--edu-a); border-color: rgba(45,122,90,0.2); }
.ctx-card.biz:hover .ctx-tag { background: rgba(43,75,191,0.1); color: var(--biz-a); border-color: rgba(43,75,191,0.2); }
.ctx-card.evt:hover .ctx-tag { background: rgba(194,51,122,0.1); color: var(--evt-a); border-color: rgba(194,51,122,0.2); }

/* Join form */
.join-section { max-width: 400px; }

.join-section h2 {
  font-family: var(--font); font-weight: 700;
  font-size: 26px; margin-bottom: 16px;
}

.join-row { display: flex; gap: 10px; }

.join-input {
  flex: 1;
  border: 2px solid var(--border);
  border-radius: 12px;
  background: var(--off);
  padding: 12px 16px;
  font-size: 16px; font-weight: 600;
  letter-spacing: 3px;
  text-transform: uppercase;
  outline: none;
  transition: border-color 0.2s;
  color: var(--text);
}
.join-input:focus { border-color: var(--text); background: var(--white); }

.btn-join {
  background: var(--text);
  color: var(--white);
  border: none;
  padding: 12px 24px;
  border-radius: 12px;
  font-size: 14px; font-weight: 600;
  transition: all 0.2s;
}
.btn-join:hover { opacity: 0.85; }

/* ============================================================
   HOST SCREEN
============================================================ */
#screen-host {
  flex-direction: column;
}

.host-nav {
  background: var(--surface-nav);
  border-bottom: 1px solid var(--border);
  padding: 0 28px;
  display: flex; align-items: center; gap: 0;
  height: 58px;
  position: sticky; top: 0; z-index: 100;
}

.nav-logo {
  font-family: var(--font); font-weight: 700;
  font-size: 22px;
  color: var(--text);
  margin-right: 28px;
  text-decoration: none;
}

.nav-context-pill {
  display: flex; align-items: center; gap: 8px;
  padding: 5px 14px;
  border-radius: 100px;
  font-size: 12px; font-weight: 600;
  margin-right: 24px;
  background: var(--theme-l);
  color: var(--theme-a);
}

.nav-tabs { display: flex; gap: 2px; flex: 1; }

.nav-tab {
  padding: 6px 16px;
  border-radius: 8px;
  border: none;
  background: transparent;
  font-size: 13px; font-weight: 500;
  color: var(--muted);
  transition: all 0.15s;
  white-space: nowrap;
}
.nav-tab:hover { background: var(--off); color: var(--text); }
.nav-tab.active { background: var(--theme-l); color: var(--theme-a); font-weight: 600; }

.nav-right { display: flex; align-items: center; gap: 10px; margin-left: auto; }

.nav-room-code {
  font-size: 12px; font-weight: 700;
  letter-spacing: 2px;
  color: var(--muted);
  padding: 5px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--off);
}

.nav-room-code span {
  color: var(--theme-a);
}

.btn-sm {
  padding: 7px 16px;
  border-radius: 8px;
  font-size: 12px; font-weight: 600;
  border: none;
  transition: all 0.2s;
  white-space: nowrap;
}

.btn-primary-theme {
  background: var(--theme-g);
  color: var(--white);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.btn-primary-theme:hover { opacity: 0.9; transform: translateY(-1px); }

.btn-ghost {
  background: transparent;
  color: var(--muted);
  border: 1px solid var(--border);
}
.btn-ghost:hover { border-color: var(--border2); color: var(--text); background: var(--off); }

/* HOST BODY */
.host-body {
  display: grid;
  grid-template-columns: 260px 1fr 300px;
  flex: 1;
  min-height: 0;
}

/* LEFT PANEL */
.left-panel {
  background: var(--surface-sidebar);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  overflow: hidden;
}

.panel-section { padding: 20px; border-bottom: 1px solid var(--border); }
.panel-section-title {
  font-size: 10px; font-weight: 700;
  letter-spacing: 2px; text-transform: uppercase;
  color: var(--muted2);
  margin-bottom: 12px;
}

.activity-nav { display: flex; flex-direction: column; gap: 4px; }

.act-btn {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px;
  border-radius: var(--r-sm);
  border: none;
  background: transparent;
  color: var(--muted);
  font-size: 13px; font-weight: 500;
  transition: all 0.15s;
  text-align: left; width: 100%;
}
.act-btn:hover { background: var(--off); color: var(--text); }
.act-btn.active {
  background: var(--theme-l);
  color: var(--theme-a);
  font-weight: 600;
}

.act-btn-icon {
  width: 32px; height: 32px;
  border-radius: var(--r-sm);
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  background: var(--off);
  flex-shrink: 0;
  transition: background 0.15s;
}
.act-btn.active .act-btn-icon { background: var(--theme-a); }

.act-count {
  margin-left: auto;
  font-size: 10px; font-weight: 700;
  background: var(--off2);
  color: var(--muted);
  padding: 2px 7px;
  border-radius: 100px;
}

/* Templates */
.template-list { display: flex; flex-direction: column; gap: 6px; overflow-y: auto; padding: 16px; flex: 1; }

.template-item {
  display: flex; align-items: flex-start; gap: 10px;
  padding: 10px 12px;
  border-radius: var(--r-sm);
  border: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.15s;
  background: var(--white);
}
.template-item:hover { border-color: var(--theme-a); background: var(--theme-l); }

.t-icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }
.t-name { font-size: 12px; font-weight: 600; color: var(--text); }
.t-desc { font-size: 11px; color: var(--muted); }

/* MAIN CENTER */
.main-center { overflow-y: auto; padding: 28px; display: flex; flex-direction: column; gap: 20px; }

/* Activity panels */
.activity-panel { display: none; }
.activity-panel.active { display: block; animation: fadeUp 0.25s ease; }

@keyframes fadeUp {
  from { opacity:0; transform:translateY(8px); }
  to { opacity:1; transform:translateY(0); }
}

.card {
  background: var(--surface-card);
  border: 1px solid var(--border);
  border-radius: 20px;
  overflow: hidden;
}

.card-header {
  padding: 20px 24px 16px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 12px;
}

.card-header-icon {
  width: 40px; height: 40px;
  border-radius: 10px;
  background: var(--theme-l);
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  flex-shrink: 0;
}

.card-title {
  font-family: var(--font); font-weight: 700;
  font-size: 20px;
  flex: 1;
}

.card-body { padding: 24px; }

/* Form elements */
.form-group { margin-bottom: 18px; }

.form-label {
  display: block;
  font-size: 11px; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 7px;
}

.form-input {
  width: 100%;
  background: var(--off);
  border: 1.5px solid var(--border);
  border-radius: 10px;
  padding: 11px 14px;
  font-size: 14px;
  color: var(--text);
  outline: none;
  transition: all 0.2s;
}
.form-input:focus { border-color: var(--theme-a); background: var(--white); }

.form-textarea { min-height: 80px; resize: vertical; }

.options-container { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }

.opt-row { display: flex; gap: 8px; align-items: center; }
.opt-row .form-input { flex: 1; }

.btn-opt-remove {
  width: 34px; height: 34px;
  border-radius: 8px;
  border: 1.5px solid var(--border);
  background: transparent;
  color: var(--muted2);
  font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  transition: all 0.15s;
}
.btn-opt-remove:hover { border-color: #e55; color: #e55; }

.btn-add-opt {
  display: flex; align-items: center; gap: 6px;
  padding: 8px 14px;
  border-radius: 8px;
  border: 1.5px dashed var(--border2);
  background: transparent;
  color: var(--muted);
  font-size: 12px; font-weight: 600;
  transition: all 0.15s;
  width: fit-content;
}
.btn-add-opt:hover { border-color: var(--theme-a); color: var(--theme-a); background: var(--theme-l); }

.action-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }

.btn-launch {
  padding: 12px 28px;
  border-radius: 10px;
  border: none;
  background: var(--theme-g);
  color: var(--white);
  font-size: 14px; font-weight: 700;
  letter-spacing: -0.2px;
  box-shadow: 0 3px 12px rgba(0,0,0,0.15);
  transition: all 0.2s;
}
.btn-launch:hover { transform: translateY(-1px); box-shadow: 0 5px 16px rgba(0,0,0,0.2); }

.btn-outline {
  padding: 12px 20px;
  border-radius: 10px;
  border: 1.5px solid var(--border);
  background: transparent;
  color: var(--text);
  font-size: 14px; font-weight: 600;
  transition: all 0.2s;
}
.btn-outline:hover { border-color: var(--border2); background: var(--off); }

/* Poll Results */
.result-header { margin-bottom: 20px; }
.result-q { font-family: var(--font); font-weight: 700; font-size: 22px; margin-bottom: 6px; }
.result-meta { font-size: 12px; color: var(--muted); }

.result-bar-item { margin-bottom: 14px; }
.result-bar-label { display: flex; justify-content: space-between; font-size: 13px; font-weight: 500; margin-bottom: 5px; }
.result-bar-label .pct { font-weight: 700; color: var(--theme-a); }
.bar-track { height: 8px; background: var(--off2); border-radius: 100px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 100px; background: var(--theme-g); transition: width 0.7s cubic-bezier(0.34,1.56,0.64,1); }

.vote-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 20px; }

.v-btn {
  padding: 12px 14px;
  border-radius: 10px;
  border: 1.5px solid var(--border);
  background: var(--off);
  color: var(--text);
  font-size: 13px; font-weight: 500;
  transition: all 0.2s;
  text-align: left;
}
.v-btn:hover { border-color: var(--theme-a); background: var(--theme-l); color: var(--theme-a); }
.v-btn.selected { border-color: var(--theme-a); background: var(--theme-l); color: var(--theme-a); font-weight: 700; }

/* Word Cloud */
.wc-canvas {
  background: var(--off);
  border-radius: 12px;
  min-height: 260px;
  display: flex; flex-wrap: wrap;
  align-items: center; justify-content: center;
  gap: 10px 14px;
  padding: 24px;
  position: relative;
}

.wc-word {
  border-radius: 100px;
  font-weight: 700;
  letter-spacing: -0.3px;
  transition: transform 0.2s;
  cursor: default;
  animation: popIn 0.4s cubic-bezier(0.34,1.56,0.64,1);
  padding: 3px 12px;
}
.wc-word:hover { transform: scale(1.08); }

@keyframes popIn {
  from { opacity:0; transform:scale(0.5) rotate(-5deg); }
  to { opacity:1; transform:scale(1) rotate(0); }
}

.wc-input-row { display: flex; gap: 8px; margin-top: 14px; }
.wc-input-row .form-input { flex: 1; }

/* Q&A */
.qa-submit-area { margin-bottom: 20px; }
.qa-list { display: flex; flex-direction: column; gap: 10px; max-height: 480px; overflow-y: auto; padding-right: 4px; }
.qa-list::-webkit-scrollbar { width: 3px; }
.qa-list::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

.qa-card {
  background: var(--off);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
  transition: all 0.2s;
  animation: fadeUp 0.25s ease;
}
.qa-card:hover { border-color: var(--border2); }
.qa-card.answered { border-left: 3px solid var(--theme-a); }

.qa-q { font-size: 14px; font-weight: 500; margin-bottom: 10px; line-height: 1.4; }

.qa-footer { display: flex; align-items: center; justify-content: space-between; }
.qa-author { font-size: 11px; color: var(--muted2); }

.qa-actions { display: flex; align-items: center; gap: 6px; }

.up-btn {
  display: flex; align-items: center; gap: 5px;
  padding: 4px 10px; border-radius: 6px;
  border: 1px solid var(--border);
  background: var(--white);
  font-size: 11px; font-weight: 600; color: var(--muted);
  transition: all 0.15s;
}
.up-btn:hover { border-color: var(--theme-a); color: var(--theme-a); background: var(--theme-l); }
.up-btn.voted { background: var(--theme-l); color: var(--theme-a); border-color: var(--theme-a); }

.mark-answered-btn {
  padding: 4px 10px; border-radius: 6px;
  border: 1px solid var(--border);
  background: var(--white);
  font-size: 11px; font-weight: 600; color: var(--muted);
  transition: all 0.15s;
}
.mark-answered-btn:hover { background: var(--theme-l); color: var(--theme-a); border-color: var(--theme-a); }

.answered-tag {
  font-size: 10px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase;
  padding: 3px 8px; border-radius: 6px;
  background: var(--theme-l); color: var(--theme-a);
}

/* Quiz */
.quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.quiz-progress { font-size: 13px; color: var(--muted); }
.quiz-score-badge {
  font-size: 13px; font-weight: 700;
  padding: 5px 12px; border-radius: 8px;
  background: var(--theme-l); color: var(--theme-a);
}

.timer-track { height: 4px; background: var(--off2); border-radius: 100px; margin-bottom: 24px; overflow: hidden; }
.timer-bar { height: 100%; background: var(--theme-g); border-radius: 100px; transition: width linear; }

.quiz-q { font-family: var(--font); font-weight: 700; font-size: 24px; line-height: 1.25; margin-bottom: 24px; }

.quiz-opts { display: flex; flex-direction: column; gap: 10px; }

.q-opt {
  display: flex; align-items: center; gap: 14px;
  padding: 14px 18px;
  border-radius: 12px;
  border: 1.5px solid var(--border);
  background: var(--off);
  font-size: 15px; font-weight: 500;
  transition: all 0.2s;
}
.q-opt:hover { border-color: var(--theme-a); background: var(--theme-l); cursor: pointer; }
.q-opt.correct { border-color: #22a05a; background: #e6f7ee; color: #1a6b3a; }
.q-opt.wrong { border-color: #e05050; background: #fdeaea; color: #b03030; animation: shake 0.3s ease; }

.q-opt-key {
  width: 28px; height: 28px; flex-shrink: 0;
  border-radius: 7px;
  background: var(--off2);
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 700;
  transition: background 0.2s;
}
.q-opt.correct .q-opt-key { background: #22a05a; color: white; }
.q-opt.wrong .q-opt-key { background: #e05050; color: white; }

@keyframes shake {
  0%,100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

.quiz-result {
  text-align: center; padding: 30px 0;
}
.quiz-result-score {
  font-family: var(--font); font-weight: 700;
  font-size: 80px; line-height: 1;
  margin-bottom: 12px;
}
.quiz-result-label { font-size: 16px; color: var(--muted); margin-bottom: 28px; }

/* Rating */
.rating-container { text-align: center; padding: 10px 0 20px; }
.rating-stars { display: flex; justify-content: center; gap: 10px; font-size: 40px; margin: 16px 0; }
.star { cursor: pointer; transition: transform 0.2s; opacity: 0.3; }
.star:hover, .star.active { opacity: 1; transform: scale(1.15); }
.rating-label { font-size: 14px; color: var(--muted); min-height: 22px; }
.rating-result { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 20px; }
.rating-avg { font-family: var(--font); font-weight: 700; font-size: 48px; line-height: 1; }
.rating-count { font-size: 13px; color: var(--muted); }

/* Slider Poll */
.slider-container { padding: 20px 0; }
.slider-row { display: flex; align-items: center; gap: 14px; margin-bottom: 12px; }
.range-slider {
  flex: 1; height: 6px; accent-color: var(--theme-a);
  cursor: pointer;
}
.slider-val {
  font-family: var(--font); font-weight: 700;
  font-size: 22px; min-width: 40px; text-align: center; color: var(--theme-a);
}
.slider-result-bar { height: 8px; background: var(--off2); border-radius: 100px; overflow: hidden; margin-bottom: 8px; }
.slider-result-fill { height: 100%; background: var(--theme-g); border-radius: 100px; transition: width 0.6s ease; }

/* RIGHT PANEL */
.right-panel {
  background: var(--surface-sidebar);
  border-left: 1px solid var(--border);
  overflow-y: auto;
  display: flex; flex-direction: column;
}

.rp-section { padding: 20px; border-bottom: 1px solid var(--border); }
.rp-title { font-size: 11px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--muted2); margin-bottom: 14px; }

.stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.stat-box {
  background: var(--off);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px;
  text-align: center;
}
.stat-num { font-family: var(--font); font-weight: 700; font-size: 32px; line-height: 1; color: var(--theme-a); }
.stat-lbl { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }

.live-feed { display: flex; flex-direction: column; gap: 6px; }
.feed-item {
  display: flex; align-items: flex-start; gap: 8px;
  font-size: 12px; line-height: 1.4;
  padding: 8px 10px;
  background: var(--off);
  border-radius: 8px;
  animation: slideIn 0.3s ease;
}
@keyframes slideIn {
  from { opacity:0; transform:translateX(8px); }
  to { opacity:1; transform:translateX(0); }
}
.feed-dot { width: 6px; height: 6px; border-radius: 50%; margin-top: 4px; flex-shrink: 0; }
.feed-txt { flex: 1; color: var(--text); }
.feed-time { color: var(--muted2); font-size: 10px; white-space: nowrap; }

/* QR */
.qr-box {
  display: flex; flex-direction: column; align-items: center; gap: 10px;
  background: var(--off);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
}
.qr-svg-wrap { background: white; padding: 10px; border-radius: 8px; }
.qr-link { font-size: 11px; font-weight: 600; color: var(--muted); letter-spacing: 0.3px; text-align: center; }
.qr-link span { color: var(--theme-a); }

/* Participant counter ring */
.participant-ring {
  width: 80px; height: 80px;
  position: relative;
  margin: 0 auto;
}
.participant-ring svg { transform: rotate(-90deg); }
.ring-bg { fill: none; stroke: var(--off2); stroke-width: 4; }
.ring-fill { fill: none; stroke-width: 4; stroke-linecap: round; stroke: var(--theme-a); transition: stroke-dashoffset 1s ease; }
.ring-text {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
}
.ring-num { font-family: var(--font); font-weight: 700; font-size: 22px; line-height: 1; color: var(--theme-a); }
.ring-sub { font-size: 9px; color: var(--muted2); text-transform: uppercase; letter-spacing: 0.5px; }

/* Engagement indicator */
.engagement-bar { height: 6px; background: var(--off2); border-radius: 100px; overflow: hidden; }
.engagement-fill {
  height: 100%;
  border-radius: 100px;
  background: linear-gradient(90deg, #22a05a, var(--theme-a));
  transition: width 1s ease;
}

/* Live indicator */
.live-badge {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 3px 10px;
  background: #fef0f0;
  border: 1px solid #fcc;
  border-radius: 100px;
  font-size: 10px; font-weight: 700;
  color: #e05050;
  text-transform: uppercase; letter-spacing: 1px;
}
.live-dot-red { width: 6px; height: 6px; background: #e05050; border-radius: 50%; animation: blink 1.2s infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }

/* ============================================================
   PARTICIPANT SCREEN
============================================================ */
#screen-participant {
  background: var(--white);
  align-items: stretch;
}

.participant-header {
  padding: 18px 24px;
  display: flex; align-items: center; justify-content: space-between;
  border-bottom: 1px solid var(--border);
  background: var(--white);
}

.participant-header .logo {
  font-family: var(--font); font-weight: 700;
  font-size: 20px;
}

.participant-body { flex: 1; padding: 32px 24px; max-width: 560px; margin: 0 auto; width: 100%; }

.p-context-label {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 5px 14px;
  border-radius: 100px;
  background: var(--theme-l);
  color: var(--theme-a);
  font-size: 12px; font-weight: 700;
  margin-bottom: 24px;
}

.p-card {
  background: var(--off);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 28px;
}

.p-title {
  font-family: var(--font); font-weight: 700;
  font-size: 24px;
  line-height: 1.2;
  margin-bottom: 20px;
}

/* ============================================================
   DARK MODE OVERRIDES
============================================================ */
body.ui-dark .form-input {
  background: #1a1a2c; color: var(--text); border-color: var(--border);
}
body.ui-dark .form-input:focus { background: #22223a; border-color: var(--theme-a); }
body.ui-dark .join-input { background: #1a1a2c; color: var(--text); }
body.ui-dark .join-input:focus { background: #22223a; }
body.ui-dark .ctx-card { background: #1a1a2c; }
body.ui-dark .ctx-card:hover::before { opacity: 1; }
body.ui-dark .ctx-card.edu:hover::before { background: rgba(45,122,90,0.12); }
body.ui-dark .ctx-card.biz:hover::before { background: rgba(43,75,191,0.12); }
body.ui-dark .ctx-card.evt:hover::before { background: rgba(194,51,122,0.12); }
body.ui-dark .ctx-title { color: var(--text); }
body.ui-dark .template-item { background: #1a1a2c; }
body.ui-dark .qa-card { background: #1a1a2c; }
body.ui-dark .stat-box { background: #1a1a2c; }
body.ui-dark .feed-item { background: #1a1a2c; }
body.ui-dark .v-btn { background: #1a1a2c; }
body.ui-dark .q-opt { background: #1a1a2c; }
body.ui-dark .wc-canvas { background: #1a1a2c; }
body.ui-dark .qr-box { background: #1a1a2c; }
body.ui-dark .btn-outline { background: #1a1a2c; }
body.ui-dark .btn-hero-primary { background: var(--text); color: var(--off); }
body.ui-dark .up-btn { background: #1a1a2c; }
body.ui-dark .mark-answered-btn { background: #1a1a2c; }
body.ui-dark .landing-body { background: var(--off); }
body.ui-dark #screen-landing { background: var(--off); }
body.ui-dark .ui-sw-btn.active { background: #2a2a40; }

/* ============================================================
   VIVID MODE OVERRIDES
============================================================ */
body.ui-vivid .landing-hero { background: linear-gradient(135deg, #ff6b35 0%, #f72585 45%, #7209b7 100%); }
body.ui-vivid .ctx-card { background: #fff8f0; }
body.ui-vivid .hero-title { color: #fff; }
body.ui-vivid .hero-eyebrow { color: rgba(255,255,255,0.6); }
body.ui-vivid .hero-sub { color: rgba(255,255,255,0.65); }
body.ui-vivid .btn-hero-primary { background: #fff; color: #1a1200; }
body.ui-vivid .stat-num { font-weight: 800; }
body.ui-vivid .bar-fill { background: var(--theme-g); }

/* Scrollbar */
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

/* â”€â”€ Firebase Setup Banner â”€â”€ */
#firebase-banner {
  position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
  background: #1a1200; color: #fff;
  border: 1px solid #ff9500;
  border-radius: 12px;
  padding: 12px 20px;
  display: flex; align-items: center; gap: 12px;
  font-size: 13px; font-weight: 500;
  z-index: 9999;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  max-width: 560px; width: calc(100% - 32px);
  animation: slideUp 0.4s ease;
}
@keyframes slideUp {
  from { opacity:0; transform: translateX(-50%) translateY(20px); }
  to   { opacity:1; transform: translateX(-50%) translateY(0); }
}
#firebase-banner .fb-icon { font-size: 22px; flex-shrink:0; }
#firebase-banner .fb-text { flex:1; line-height:1.4; }
#firebase-banner .fb-text strong { color: #ff9500; }
#firebase-banner .fb-close {
  background: rgba(255,149,0,0.15); border: 1px solid rgba(255,149,0,0.3);
  color: #ff9500; padding: 4px 12px; border-radius: 6px;
  font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap;
}
#firebase-banner .fb-close:hover { background: rgba(255,149,0,0.25); }

/* â”€â”€ Firebase connection status dot â”€â”€ */
.fb-status {
  width: 8px; height: 8px; border-radius: 50%;
  background: #ccc; flex-shrink: 0;
  transition: background 0.3s;
}
.fb-status.connected { background: #22c55e; box-shadow: 0 0 6px rgba(34,197,94,0.5); }
.fb-status.demo { background: #f59e0b; }

/* â”€â”€ Participant full page â”€â”€ */
#screen-participant {
  background: var(--surface-card);
}
.participant-header {
  background: var(--surface-nav);
  border-bottom: 1px solid var(--border);
}
body.ui-dark #screen-participant { background: var(--off); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Landing simplification + Unified History + Mobile
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.new-session-card{
  margin-top:14px;
  border:1px solid var(--border);
  background:var(--surface);
  border-radius:18px;
  padding:14px;
  display:flex;
  gap:14px;
  align-items:stretch;
}
.new-session-left{flex:1; min-width:220px;}
.new-session-head{font-weight:950; letter-spacing:-0.02em;}
.new-session-chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
.chip{
  border:1px solid var(--border);
  background:var(--off);
  border-radius:999px;
  padding:8px 10px;
  font-weight:900;
  cursor:pointer;
  font-family:var(--font);
  font-size:12px;
}
.chip.active{ background:var(--theme-a); color:#fff; border-color:transparent; }
.new-session-hint{margin-top:10px; font-size:12px; color:var(--muted); font-weight:900;}
.new-session-mini{margin-top:6px; font-size:12px; color:var(--muted); font-weight:800;}
.new-session-right{display:flex; flex-direction:column; gap:8px; justify-content:center; min-width:200px;}
.primary-btn{
  border:none; background:var(--theme-g); color:#fff;
  border-radius:14px; padding:11px 12px; font-weight:950;
  cursor:pointer; font-family:var(--font);
}
.ghost-btn{
  border:1px solid var(--border); background:var(--off);
  border-radius:14px; padding:11px 12px; font-weight:950;
  cursor:pointer; font-family:var(--font);
}
.history-block{margin-top:18px;}
.history-title{font-weight:950;}
.history-sub{font-size:12px;color:var(--muted);margin-top:2px;font-weight:800;line-height:1.4;}
.history-list{margin-top:10px;display:flex;flex-direction:column;gap:10px;}
.hist-item{
  border:1px solid var(--border);
  border-radius:16px;
  background:var(--surface);
  padding:12px;
  display:flex;
  gap:12px;
  align-items:center;
}
.hist-meta{flex:1; min-width:0;}
.hist-code{font-weight:950;}
.hist-time{font-size:12px;color:var(--muted);margin-top:3px;font-weight:800;}
.hist-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
.small-btn{
  border:1px solid var(--border);
  background:var(--off);
  border-radius:12px;
  padding:8px 10px;
  font-weight:950;
  cursor:pointer;
  font-family:var(--font);
  font-size:12px;
}
.small-btn.primary{ background:var(--theme-a); color:#fff; border-color:transparent; }
.small-btn.danger{ background:#fff; border-color:#ffb3b3; color:#b10000; }

.badge{
  display:inline-flex; align-items:center; gap:6px;
  font-size:11px; font-weight:950;
  padding:5px 8px; border-radius:999px;
  border:1px solid var(--border); background:var(--off);
  margin-right:8px;
}
.badge.fav{ border-color:transparent; background:rgba(255,215,0,0.2); }

@media (max-width: 960px){
  .new-session-card{flex-direction:column;}
  .new-session-right{min-width:unset; flex-direction:row; flex-wrap:wrap;}
  .primary-btn,.ghost-btn{flex:1; min-width:160px;}
}

@media (max-width: 720px){
  .hero{padding:22px 16px !important; min-height:unset !important;}
  .hero-title{font-size:40px !important; line-height:1.05 !important;}
  .hero-actions{flex-wrap:wrap;}
  .hero-actions button{flex:1; min-width:160px;}
  .host-shell{grid-template-columns:1fr !important;}
  .right-panel{display:none !important;}
  .hist-item{flex-direction:column;align-items:stretch;}
  .hist-actions{justify-content:flex-start;}
}


#sessionTitleInput{font-size:13px;}
@media (max-width:720px){#sessionTitleInput{font-size:14px;}}

/* Participant always-QA bar */
#qaFab{display:none !important;}
.participant-body{padding-bottom:8px;}
@media (max-width:720px){
  #qaBottomBar textarea{min-width:0 !important; width:100%;}
  #qaQuickSend{flex:1;}
}



</style>
</head>
<body>

<!-- ============================================================
     LANDING SCREEN
============================================================ -->
<div id="screen-landing" class="screen active">

  <div class="landing-hero">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:36px">
      <div style="font-size:20px;font-weight:800;color:#fff;letter-spacing:-0.5px">ACTIVELY</div>
      <div class="ui-switcher" style="background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.15)">
        <button class="ui-sw-btn active" id="land-sw-light" onclick="setUiMode('light')" title="ë¼ì´íŠ¸" style="color:#fff">â˜€ï¸</button>
        <button class="ui-sw-btn" id="land-sw-dark" onclick="setUiMode('dark')" title="ë‹¤í¬" style="color:#fff">ğŸŒ™</button>
        <button class="ui-sw-btn" id="land-sw-vivid" onclick="setUiMode('vivid')" title="ë¹„ë¹„ë“œ" style="color:#fff">ğŸ¨</button>
      </div>
    </div>
    <div class="hero-eyebrow">ì‹¤ì‹œê°„ ì²­ì¤‘ ì°¸ì—¬ í”Œë«í¼</div>
    <h1 class="hero-title">ì²­ì¤‘ì„ ëŒ€í™”ì˜<br><em>ì¤‘ì‹¬</em>ìœ¼ë¡œ</h1>
    <p class="hero-sub">ê°•ì˜, íšŒì˜, ì´ë²¤íŠ¸ ì–´ë””ì„œë‚˜. íˆ¬í‘œÂ·ì›Œë“œí´ë¼ìš°ë“œÂ·Q&AÂ·í€´ì¦ˆë¡œ ì²­ì¤‘ê³¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì†Œí†µí•˜ì„¸ìš”.</p>
    
  </div>

  
<div class="landing-body">
  <div class="section-label">ìƒˆ ì„¸ì…˜</div>
  <div class="new-session-card">
    <div class="new-session-left">
      <div class="new-session-head">ìš©ë„ ì„ íƒ</div>
      <div class="new-session-chips">
        <button class="chip active" id="chip-edu" onclick="selectCtx('edu')">ğŸ“ ê°•ì˜ & êµìœ¡</button>
        <button class="chip" id="chip-biz" onclick="selectCtx('biz')">ğŸ’¼ íšŒì‚¬ ë°œí‘œ & íšŒì˜</button>
        <button class="chip" id="chip-evt" onclick="selectCtx('evt')">ğŸ‰ ì´ë²¤íŠ¸ & í–‰ì‚¬</button>
      </div>
      <div class="new-session-hint" id="ctxHint">ì„ íƒ: ê°•ì˜ & êµìœ¡</div>
      <div class="new-session-mini">ê¸°ëŠ¥ì€ ë™ì¼í•˜ê³ , ì¶”ì²œ í…œí”Œë¦¿ë§Œ ë‹¬ë¼ìš”.</div>
      <div style="margin-top:12px;">
        <div style="font-size:12px;color:var(--muted);font-weight:900;margin-bottom:6px;">ì„¸ì…˜ ì´ë¦„</div>
        <input id="sessionTitleInput" placeholder="ì˜ˆ: 2ì›” SE êµìœ¡ / íŒ€ ì£¼ê°„íšŒì˜" style="width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--surface);font-family:var(--font);font-weight:850;outline:none;" />
      </div>
    </div>

    <div class="new-session-right">
      <button class="primary-btn" onclick="createNewSession()">ğŸš€ ìƒˆ ì„¸ì…˜ ë§Œë“¤ê¸°</button>
      <button class="ghost-btn" onclick="openUnifiedHistory()">ğŸ—‚ ì„¸ì…˜ íˆìŠ¤í† ë¦¬</button>
    </div>
  </div>

  <div class="history-block">
    <div class="history-title">ìµœê·¼ ê¸°ë¡</div>
    <div class="history-sub">ê¸°ê¸°/ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ìµœê·¼ ì„¸ì…˜ì´ì—ìš”. (ê´€ë¦¬ì ë§í¬ë¡œ ì ‘ì†í•˜ë©´ ëª¨ë“  ê¸°ê¸°ì—ì„œ íˆìŠ¤í† ë¦¬ê°€ ë™ê¸°í™”ë¼ìš”)</div>
    <div id="localHistory" class="history-list"></div>
  </div>
</div>
</div>

<!-- ============================================================
     HOST SCREEN
============================================================ -->
<div id="screen-host" class="screen">

  <nav class="host-nav">
    <a class="nav-logo" onclick="goHome()" style="cursor:pointer">ACTIVELY</a>
    <div class="nav-context-pill" id="navCtxPill">ğŸ“ ê°•ì˜/êµìœ¡</div>
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchActivity('poll',this)">ğŸ“Š íˆ¬í‘œ</button>
      <button class="nav-tab" onclick="switchActivity('wordcloud',this)">â˜ï¸ ì›Œë“œí´ë¼ìš°ë“œ</button>
      <button class="nav-tab" onclick="switchActivity('qa',this)">ğŸ’¬ Q&A</button>
      <button class="nav-tab" onclick="switchActivity('quiz',this)">ğŸ¯ í€´ì¦ˆ</button>
      <button class="nav-tab" onclick="switchActivity('rating',this)">â­ ë§Œì¡±ë„</button>
      <button class="nav-tab" onclick="switchActivity('slider',this)">ğŸšï¸ ìŠ¬ë¼ì´ë”</button>
    </div>
    <div class="nav-right">
      <div class="live-badge"><div class="live-dot-red"></div> LIVE</div>
      <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted)" title="Firebase ì—°ê²° ìƒíƒœ">
        <div class="fb-status" id="fbStatusDot"></div>
        <span id="fbStatusLabel">ë°ëª¨ ëª¨ë“œ</span>
      </div>
      <div class="ui-switcher" title="UI í…Œë§ˆ ë³€ê²½">
        <button class="ui-sw-btn active" id="sw-light" onclick="setUiMode('light')" title="ë¼ì´íŠ¸">â˜€ï¸</button>
        <button class="ui-sw-btn" id="sw-dark" onclick="setUiMode('dark')" title="ë‹¤í¬">ğŸŒ™</button>
        <button class="ui-sw-btn" id="sw-vivid" onclick="setUiMode('vivid')" title="ë¹„ë¹„ë“œ">ğŸ¨</button>
      </div>
      <div class="nav-room-code">ì°¸ì—¬ ì½”ë“œ <span id="navRoomCode">â€”</span></div>
      <button class="btn-sm btn-ghost" onclick="previewParticipant()">ğŸ‘¤ ì°¸ì—¬ì í™”ë©´</button>
      <button class="btn-sm btn-primary-theme" onclick="copyJoinLink()">ğŸ”— ë§í¬ ë³µì‚¬</button>
    </div>
  </nav>

  <!-- ì„¸ì…˜ ì œëª© ë°°ë„ˆ -->
  <div id="hostTitleBanner" style="display:none; background:var(--theme-l); border-bottom:2px solid var(--theme-a); padding:10px 28px; display:flex; align-items:center; gap:12px;">
    <span style="font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--theme-a);opacity:0.7;">ì„¸ì…˜</span>
    <span id="sessionTitleTop" style="font-size:22px;font-weight:900;color:var(--theme-h);letter-spacing:-0.5px;"></span>
  </div>

  <div class="host-body">

    <!-- LEFT -->
    <aside class="left-panel">
      <div class="panel-section">
        <div class="panel-section-title">í™œë™ ê´€ë¦¬</div>
        <div class="activity-nav" id="actNav">
          <button class="act-btn active" onclick="switchActivity('poll',this)">
            <div class="act-btn-icon">ğŸ“Š</div>
            <span>ì‹¤ì‹œê°„ íˆ¬í‘œ</span>
            <span class="act-count" id="cnt-poll">0</span>
          </button>
          <button class="act-btn" onclick="switchActivity('wordcloud',this)">
            <div class="act-btn-icon">â˜ï¸</div>
            <span>ì›Œë“œí´ë¼ìš°ë“œ</span>
            <span class="act-count" id="cnt-wc">0</span>
          </button>
          <button class="act-btn" onclick="switchActivity('qa',this)">
            <div class="act-btn-icon">ğŸ’¬</div>
            <span>Q&A</span>
            <span class="act-count" id="cnt-qa">0</span>
          </button>
          <button class="act-btn" onclick="switchActivity('quiz',this)">
            <div class="act-btn-icon">ğŸ¯</div>
            <span>í€´ì¦ˆ</span>
            <span class="act-count" id="cnt-quiz">0</span>
          </button>
          <button class="act-btn" onclick="switchActivity('rating',this)">
            <div class="act-btn-icon">â­</div>
            <span>ë§Œì¡±ë„ í‰ê°€</span>
            <span class="act-count" id="cnt-rating">0</span>
          </button>
          <button class="act-btn" onclick="switchActivity('slider',this)">
            <div class="act-btn-icon">ğŸšï¸</div>
            <span>ìŠ¬ë¼ì´ë” íˆ¬í‘œ</span>
            <span class="act-count" id="cnt-slider">0</span>
          </button>
        </div>
      </div>

      <div class="panel-section" style="flex:1;overflow:hidden;display:flex;flex-direction:column;padding-bottom:0">
        <div class="panel-section-title">í…œí”Œë¦¿</div>
        <div class="template-list" id="templateList">
          <!-- populated by JS -->
        </div>
      </div>
    </aside>

    <!-- CENTER -->
    <main class="main-center">

      <!-- POLL -->
      <div class="activity-panel active" id="ap-poll">
        <!-- Edit -->
        <div class="card" id="poll-edit-card">
          <div class="card-header">
            <div class="card-header-icon">ğŸ“Š</div>
            <div class="card-title">ì‹¤ì‹œê°„ íˆ¬í‘œ ì„¤ì •</div>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">ì§ˆë¬¸</label>
              <input type="text" class="form-input" id="pollQ" placeholder="ì°¸ì—¬ìë“¤ì—ê²Œ ë¬¼ì–´ë³¼ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”" value="ì˜¤ëŠ˜ ê°•ì˜ì—ì„œ ê°€ì¥ ì–´ë ¤ì› ë˜ ë¶€ë¶„ì€?">
            </div>
            <div class="form-group">
              <label class="form-label">ì„ íƒì§€</label>
              <div class="options-container" id="pollOpts">
                <div class="opt-row"><input type="text" class="form-input" value="ê°œë… ì´í•´"><button class="btn-opt-remove" onclick="rmOpt(this)">Ã—</button></div>
                <div class="opt-row"><input type="text" class="form-input" value="ì½”ë“œ ì‹¤ìŠµ"><button class="btn-opt-remove" onclick="rmOpt(this)">Ã—</button></div>
                <div class="opt-row"><input type="text" class="form-input" value="Q&A ì‹œê°„"><button class="btn-opt-remove" onclick="rmOpt(this)">Ã—</button></div>
                <div class="opt-row"><input type="text" class="form-input" value="ì—†ìŒ (ëª¨ë‘ ì´í•´í–ˆì–´ìš”)"><button class="btn-opt-remove" onclick="rmOpt(this)">Ã—</button></div>
              </div>
              <button class="btn-add-opt" onclick="addOpt()">+ ì„ íƒì§€ ì¶”ê°€</button>
            </div>
            <div class="action-row">
              <button class="btn-launch" onclick="launchPoll()">ğŸš€ íˆ¬í‘œ ì‹œì‘</button>
              <button class="btn-outline" onclick="simulateVotes()">ğŸ² í…ŒìŠ¤íŠ¸ ë°ì´í„°</button>
            </div>
          </div>
        </div>

        <!-- Results -->
        <div class="card" id="poll-result-card" style="display:none">
          <div class="card-header">
            <div class="card-header-icon">ğŸ“Š</div>
            <div class="card-title">íˆ¬í‘œ ê²°ê³¼</div>
            <div class="live-badge"><div class="live-dot-red"></div> ì§„í–‰ì¤‘</div>
          </div>
          <div class="card-body">
            <div class="result-header">
              <div class="result-q" id="pr-question"></div>
              <div class="result-meta" id="pr-meta">0í‘œ ì§‘ê³„ë¨</div>
            </div>
            <div id="pr-bars"></div>
            <div class="action-row">
              <button class="btn-outline" onclick="resetPoll()">ğŸ”„ ì´ˆê¸°í™”</button>
              <button class="btn-outline" onclick="editPoll()">âœï¸ ìˆ˜ì •</button>
              <button class="btn-launch" onclick="simulateVotes()">+ í…ŒìŠ¤íŠ¸ íˆ¬í‘œ</button>
            </div>
          </div>
        </div>
      </div>

      <!-- WORD CLOUD -->
      <div class="activity-panel" id="ap-wordcloud">
        <div class="card">
          <div class="card-header">
            <div class="card-header-icon">â˜ï¸</div>
            <div class="card-title">ì›Œë“œí´ë¼ìš°ë“œ</div>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">í”„ë¡¬í”„íŠ¸ ì§ˆë¬¸</label>
              <input type="text" class="form-input" id="wcPrompt" value="ì´ë²ˆ ê°•ì˜ë¥¼ í•œ ë‹¨ì–´ë¡œ í‘œí˜„í•œë‹¤ë©´?">
            </div>
            <div class="wc-canvas" id="wcCanvas">
              <span style="color:var(--muted);font-size:13px">ì•„ì§ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤ â€” ì•„ë˜ì—ì„œ ë¨¼ì € ì¶”ê°€í•´ë³´ì„¸ìš”</span>
            </div>
            <div class="wc-input-row">
              <input type="text" class="form-input" id="wcInput" placeholder="ë‹¨ì–´ ì…ë ¥ í›„ Enter">
              <button class="btn-launch" onclick="addWcWord()">ì¶”ê°€</button>
            </div>
            <div style="margin-top:10px;display:flex;gap:8px">
              <button class="btn-outline" onclick="loadDemoWords()">ğŸ² ë°ëª¨ ë‹¨ì–´ ë¡œë“œ</button>
              <button class="btn-outline" onclick="clearWords()">ğŸ—‘ ì´ˆê¸°í™”</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Q&A -->
      <div class="activity-panel" id="ap-qa">
        <div class="card">
          <div class="card-header">
            <div class="card-header-icon">ğŸ’¬</div>
            <div class="card-title">Q&A</div>
          </div>
          <div class="card-body">
            <div class="qa-submit-area">
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input type="text" class="form-input" id="qaIn" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." style="flex:1">
                <button class="btn-launch" onclick="addQA()">ì „ì†¡</button>
              </div>
              <div style="font-size:11px;color:var(--muted)">ğŸ’¡ ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì°¸ì—¬ìë“¤ì´ ì§ì ‘ ìì‹ ì˜ í™”ë©´ì—ì„œ ì§ˆë¬¸ì„ ì…ë ¥í•©ë‹ˆë‹¤.</div>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:16px">
              <button class="btn-sm btn-ghost" onclick="filterQA('all')" id="qa-filter-all" style="border-color:var(--theme-a);color:var(--theme-a)">ì „ì²´</button>
              <button class="btn-sm btn-ghost" onclick="filterQA('unanswered')" id="qa-filter-unanswered">ë¯¸ë‹µë³€</button>
              <button class="btn-sm btn-ghost" onclick="filterQA('answered')" id="qa-filter-answered">ë‹µë³€ ì™„ë£Œ</button>
            </div>
            <div class="qa-list" id="qaList"></div>
          </div>
        </div>
      </div>

      <!-- QUIZ -->
      <div class="activity-panel" id="ap-quiz">
        <div class="card">
          <div class="card-header">
            <div class="card-header-icon">ğŸ¯</div>
            <div class="card-title">í€´ì¦ˆ</div>
          </div>
          <div class="card-body" id="quizBody"></div>
        </div>
      </div>

      <!-- RATING -->
      <div class="activity-panel" id="ap-rating">
        <div class="card">
          <div class="card-header">
            <div class="card-header-icon">â­</div>
            <div class="card-title">ë§Œì¡±ë„ í‰ê°€</div>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">í‰ê°€ ì§ˆë¬¸</label>
              <input type="text" class="form-input" id="ratingQ" value="ì˜¤ëŠ˜ ê°•ì˜ì˜ ì „ë°˜ì ì¸ ë§Œì¡±ë„ëŠ”?">
            </div>
            <div class="rating-container">
              <div id="ratingQDisplay" style="font-family:var(--font);font-weight:700;font-size:20px;margin-bottom:8px">ì˜¤ëŠ˜ ê°•ì˜ì˜ ì „ë°˜ì ì¸ ë§Œì¡±ë„ëŠ”?</div>
              <div class="rating-stars" id="ratingStars">
                <span class="star" onclick="rate(1)" onmouseover="hoverStar(1)" onmouseout="unhoverStar()">â˜…</span>
                <span class="star" onclick="rate(2)" onmouseover="hoverStar(2)" onmouseout="unhoverStar()">â˜…</span>
                <span class="star" onclick="rate(3)" onmouseover="hoverStar(3)" onmouseout="unhoverStar()">â˜…</span>
                <span class="star" onclick="rate(4)" onmouseover="hoverStar(4)" onmouseout="unhoverStar()">â˜…</span>
                <span class="star" onclick="rate(5)" onmouseover="hoverStar(5)" onmouseout="unhoverStar()">â˜…</span>
              </div>
              <div class="rating-label" id="ratingLabel">ë³„ì ì„ í´ë¦­í•´ í‰ê°€ì— ì°¸ì—¬í•˜ì„¸ìš”</div>
              <div class="rating-result" id="ratingResult" style="display:none">
                <div>
                  <div class="rating-avg" id="ratingAvg">â€”</div>
                  <div style="font-size:12px;color:var(--muted)">í‰ê·  ì ìˆ˜</div>
                </div>
                <div style="text-align:left">
                  <div id="ratingDistribution"></div>
                </div>
              </div>
            </div>
            <div class="action-row">
              <button class="btn-outline" onclick="resetRating()">ğŸ”„ ì´ˆê¸°í™”</button>
              <button class="btn-launch" onclick="addRandomRatings()">ğŸ² í…ŒìŠ¤íŠ¸ í‰ê°€ ì¶”ê°€</button>
            </div>
          </div>
        </div>
      </div>

      <!-- SLIDER -->
      <div class="activity-panel" id="ap-slider">
        <div class="card">
          <div class="card-header">
            <div class="card-header-icon">ğŸšï¸</div>
            <div class="card-title">ìŠ¬ë¼ì´ë” íˆ¬í‘œ</div>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">ìŠ¬ë¼ì´ë” ì§ˆë¬¸</label>
              <input type="text" class="form-input" id="sliderQ" value="ì´ ì£¼ì œë¥¼ ì–¼ë§ˆë‚˜ ì˜ ì´í•´í–ˆë‚˜ìš”?">
            </div>
            <div style="display:flex;gap:16px;margin-bottom:16px">
              <div style="flex:1">
                <label class="form-label">ìµœì†Œ ë ˆì´ë¸”</label>
                <input type="text" class="form-input" id="sliderMin" value="ì „í˜€ ëª¨ë¥´ê² ì–´ìš”">
              </div>
              <div style="flex:1">
                <label class="form-label">ìµœëŒ€ ë ˆì´ë¸”</label>
                <input type="text" class="form-input" id="sliderMax" value="ì™„ë²½í•˜ê²Œ ì´í•´í–ˆì–´ìš”">
              </div>
            </div>
            <div class="slider-container">
              <div id="sliderQDisplay" style="font-family:var(--font);font-weight:700;font-size:20px;margin-bottom:20px">ì´ ì£¼ì œë¥¼ ì–¼ë§ˆë‚˜ ì˜ ì´í•´í–ˆë‚˜ìš”?</div>
              <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:8px">
                <span id="sliderMinLbl">ì „í˜€ ëª¨ë¥´ê² ì–´ìš”</span>
                <span id="sliderMaxLbl">ì™„ë²½í•˜ê²Œ ì´í•´í–ˆì–´ìš”</span>
              </div>
              <div class="slider-row">
                <input type="range" class="range-slider" id="mySlider" min="0" max="100" value="50" oninput="updateSlider()">
                <div class="slider-val" id="sliderVal">50</div>
              </div>
              <div id="sliderResultBars" style="margin-top:20px"></div>
            </div>
            <div class="action-row">
              <button class="btn-launch" onclick="submitSlider()">ì‘ë‹µ ì œì¶œ</button>
              <button class="btn-outline" onclick="addRandomSliders()">ğŸ² í…ŒìŠ¤íŠ¸ ë°ì´í„°</button>
              <button class="btn-outline" onclick="resetSlider()">ğŸ”„ ì´ˆê¸°í™”</button>
            </div>
          </div>
        </div>
      </div>

    </main>

    <!-- RIGHT -->
    <aside class="right-panel">
      <div class="rp-section">
        <div class="rp-title">ì‹¤ì‹œê°„ í˜„í™©</div>
        <div style="margin-bottom:16px;text-align:center">
          <div class="participant-ring">
            <svg viewBox="0 0 80 80" width="80" height="80">
              <circle class="ring-bg" cx="40" cy="40" r="34"/>
              <circle class="ring-fill" id="ringFill" cx="40" cy="40" r="34"
                stroke-dasharray="213.6" stroke-dashoffset="213.6"/>
            </svg>
            <div class="ring-text">
              <div class="ring-num" id="statPart">0</div>
              <div class="ring-sub">ì°¸ì—¬ì</div>
            </div>
          </div>
        </div>
        <div class="stats-row">
          <div class="stat-box">
            <div class="stat-num" id="statResp">0</div>
            <div class="stat-lbl">ì‘ë‹µ</div>
          </div>
          <div class="stat-box">
            <div class="stat-num" id="statQ">0</div>
            <div class="stat-lbl">ì§ˆë¬¸</div>
          </div>
        </div>
        <div style="margin-top:14px">
          <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px">
            <span>ì°¸ì—¬ìœ¨</span>
            <span id="engPct" style="font-weight:600">0%</span>
          </div>
          <div class="engagement-bar">
            <div class="engagement-fill" id="engBar" style="width:0%"></div>
          </div>
        </div>
      </div>

      <div class="rp-section">
        <div class="rp-title">ì°¸ì—¬ QR & ë§í¬</div>
        <div style="display:flex;flex-direction:column;gap:10px;">
          <!-- ì§„ì§œ QR ì½”ë“œ (JSë¡œ ìƒì„±) -->
          <div style="background:var(--off);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;flex-direction:column;align-items:center;gap:8px;">
            <canvas id="qrCanvas" width="150" height="150" style="border-radius:6px;"></canvas>
            <div style="font-size:11px;color:var(--muted);text-align:center;line-height:1.5;">ì¹´ë©”ë¼ë¡œ ìŠ¤ìº”í•˜ë©´ ë°”ë¡œ ì…ì¥</div>
          </div>
          <!-- ë§í¬ ë³µì‚¬ -->
          <div style="background:var(--off);border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px;">
            <div id="joinLinkDisplay" style="background:var(--surface-card);border:1px solid var(--border);border-radius:8px;padding:9px 11px;font-size:11px;font-weight:600;color:var(--theme-a);word-break:break-all;line-height:1.5;">actively1.netlify.app</div>
            <button onclick="copyJoinLink()" id="copyLinkBtn" style="width:100%;padding:9px;border-radius:8px;border:none;background:var(--theme-g);color:#fff;font-size:12px;font-weight:700;cursor:pointer;font-family:var(--font);">ğŸ”— ë§í¬ ë³µì‚¬</button>
            

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px;">
              <button onclick="saveCurrentAs('archives')" style="padding:9px;border-radius:10px;border:1px solid var(--border);background:var(--surface);font-size:12px;font-weight:900;cursor:pointer;font-family:var(--font);">ğŸ’¾ ì„¸ì…˜ ì €ì¥</button>
              <button onclick="openSavedOverlay('archives')" style="padding:9px;border-radius:10px;border:1px solid var(--border);background:var(--off);font-size:12px;font-weight:900;cursor:pointer;font-family:var(--font);">ğŸ“š ì„¸ì…˜ ë¶ˆëŸ¬ì˜¤ê¸°</button>
              <button onclick="saveCurrentAs('templatesSaved')" style="padding:9px;border-radius:10px;border:1px solid var(--border);background:var(--surface);font-size:12px;font-weight:900;cursor:pointer;font-family:var(--font);">ğŸ“¦ í…œí”Œë¦¿ ì €ì¥</button>
              <button onclick="openSavedOverlay('templatesSaved')" style="padding:9px;border-radius:10px;border:1px solid var(--border);background:var(--off);font-size:12px;font-weight:900;cursor:pointer;font-family:var(--font);">ğŸ§© í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
<div style="display:flex;align-items:center;justify-content:center;gap:8px;padding:8px;background:var(--surface-card);border:1px solid var(--border);border-radius:8px;">
              <span style="font-size:11px;color:var(--muted);">ì°¸ì—¬ ì½”ë“œ</span>
              <span id="qrCode" style="font-size:16px;font-weight:800;letter-spacing:3px;color:var(--theme-a);">â€”</span>
            </div>
          </div>
        </div>
      </div>

      <div class="rp-section" style="flex:1;border-bottom:none">
        <div class="rp-title">ì‹¤ì‹œê°„ í™œë™</div>
        <div class="live-feed" id="liveFeed"></div>
      </div>
    </aside>
  </div>
</div>

<!-- ============================================================
     PARTICIPANT SCREEN (preview)
============================================================ -->
<div id="screen-participant" class="screen">

  <!-- â”€â”€ ë‹‰ë„¤ì„ ì…ë ¥ ì˜¤ë²„ë ˆì´ â”€â”€ -->
  <div id="nicknameOverlay" style="position:fixed;inset:0;background:var(--off);z-index:200;display:flex;align-items:center;justify-content:center;padding:24px;">
    <div style="background:var(--surface-card);border:1px solid var(--border);border-radius:24px;padding:40px 28px;max-width:380px;width:100%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.1);">
      <div style="font-size:42px;margin-bottom:14px;">ğŸ‘‹</div>
      <div style="font-size:22px;font-weight:800;margin-bottom:8px;color:var(--text);">ë°˜ê°€ì›Œìš”!</div>
      <div style="font-size:14px;color:var(--muted);margin-bottom:28px;line-height:1.7;">ì„¸ì…˜ì— ì°¸ì—¬í•˜ê¸° ì „ì—<br>ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”</div>
      <input type="text" id="nicknameInput" class="form-input"
        placeholder="ë‹‰ë„¤ì„ ì…ë ¥ (ì˜ˆ: í™ê¸¸ë™)"
        maxlength="20"
        style="text-align:center;font-size:16px;font-weight:600;margin-bottom:14px;padding:14px;"
        onkeypress="if(event.key==='Enter') confirmNickname()">
      <button onclick="confirmNickname()"
        style="width:100%;padding:15px;border-radius:12px;border:none;background:var(--theme-g);color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:var(--font);box-shadow:0 4px 16px rgba(0,0,0,0.15);">
        ì…ì¥í•˜ê¸° â†’
      </button>
      <div style="font-size:12px;color:var(--muted2);margin-top:14px;">ë‹‰ë„¤ì„ ì—†ì´ ìµëª…ìœ¼ë¡œ ì°¸ì—¬í•˜ë ¤ë©´ ì…ë ¥ ì—†ì´ ì…ì¥í•˜ê¸°ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>
    </div>
  </div>

  <div class="participant-header">
    <div class="logo">ACTIVELY</div>
    <div style="display:flex;align-items:center;gap:8px;">
      <div id="pNicknameBadge" style="display:none;font-size:12px;font-weight:700;color:var(--theme-a);background:var(--theme-l);padding:4px 12px;border-radius:100px;"></div>
      <div class="live-badge"><div class="live-dot-red"></div> ì—°ê²°ë¨</div>
    </div>
    <button class="btn-sm btn-ghost" onclick="closeParticipant()">â† ë‚˜ê°€ê¸°</button>
  </div>

  <div class="participant-body">
    <div class="p-context-label" id="pContextLabel">ğŸ“ ê°•ì˜/êµìœ¡</div>
    <div class="p-card">
      <div class="p-title" id="pTitle">ì§„í–‰ ì¤‘ì¸ í™œë™</div>
      <div id="pContent"></div>
    </div>
  </div>

  <div id="qaBottomBar" style="position:sticky;bottom:0;margin-top:14px;background:rgba(255,255,255,0.92);backdrop-filter:blur(10px);border-top:1px solid #e8e8e8;padding:10px 12px;">
    <div style="display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap;">
      <textarea id="qaQuickInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex:1;min-width:220px;min-height:44px;max-height:120px;resize:vertical;padding:10px 12px;border-radius:14px;border:1px solid #ddd;font-family:inherit;font-weight:700;outline:none;"></textarea>
      <button id="qaQuickSend" onclick="submitQuickQA()" style="border:none;background:var(--theme-a);color:#fff;border-radius:14px;padding:12px 14px;font-weight:900;cursor:pointer;min-width:92px;">ë³´ë‚´ê¸°</button>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;gap:10px;flex-wrap:wrap;">
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;font-weight:900;color:#333;">
        <input type="checkbox" id="qaAnonToggle" />
        ìµëª…ìœ¼ë¡œ ë³´ë‚´ê¸°
      </label>
      <div style="font-size:12px;color:#666;font-weight:800;">ë°œí‘œìëŠ” ì‹¤ì‹œê°„ìœ¼ë¡œ ì§ˆë¬¸ì„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.</div>
    </div>
  </div>
</div>

<!-- Firebase setup banner -->

<div id="firebase-banner" style="display:none">
  <span class="fb-icon">ğŸ”¥</span>
  <div class="fb-text">
    <strong>Firebase ë¯¸ì„¤ì • â€” ë°ëª¨ ëª¨ë“œë¡œ ì‹¤í–‰ ì¤‘</strong><br>
    ì‹¤ì œ ì‹¤ì‹œê°„ ë‹¤ì¤‘ ì‚¬ìš©ì ê¸°ëŠ¥ì„ ì“°ë ¤ë©´ Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. <strong>SETUP_GUIDE.md</strong> ì°¸ê³ 
  </div>
  <button class="fb-close" onclick="document.getElementById('firebase-banner').style.display='none'">ë‹«ê¸°</button>
</div>

<script>
// ============================================================
//   STATE
// ============================================================
let ctx = 'edu';
let roomCode = '';
let totalParticipants = 0;
let totalResponses = 0;
let totalQuestions = 0;
let isHost = false;
let currentUiMode = 'light';

// Firebase DB reference (null if not configured)
let db = null;
let fbListeners = [];
if (FIREBASE_READY) { db = firebase.database(); }

const ctxConfig = {
  edu: { label: 'ğŸ“ ê°•ì˜/êµìœ¡' },
  biz: { label: 'ğŸ’¼ íšŒì‚¬ ë°œí‘œ' },
  evt: { label: 'ğŸ‰ ì´ë²¤íŠ¸' },
};

const templates = {
  edu: [
    { icon:'ğŸ§ ', name:'ì´í•´ë„ ì²´í¬', desc:'ì„ ë‹¤í˜• ì´í•´ í™•ì¸', type:'poll', q:'ì´ ê°œë…ì„ ì–¼ë§ˆë‚˜ ì´í•´í–ˆë‚˜ìš”?', opts:['ì™„ì „íˆ ì´í•´','ëŒ€ë¶€ë¶„ ì´í•´','ì¡°ê¸ˆ í—·ê°ˆë ¤','ì „í˜€ ëª¨ë¥´ê² ì–´'] },
    { icon:'ğŸ’¡', name:'í•µì‹¬ í•™ìŠµ', desc:'ì˜¤ëŠ˜ì˜ í•µì‹¬ í‚¤ì›Œë“œ', type:'wordcloud', q:'ì˜¤ëŠ˜ ë°°ìš´ í•µì‹¬ ë‹¨ì–´ëŠ”?' },
    { icon:'â“', name:'ìˆ˜ì—… Q&A', desc:'í•™ìƒ ìµëª… ì§ˆë¬¸', type:'qa', q:'ì§ˆë¬¸ì„ ìµëª…ìœ¼ë¡œ ì˜¬ë ¤ì£¼ì„¸ìš”' },
    { icon:'ğŸ“', name:'í€´ì¦ˆ í…ŒìŠ¤íŠ¸', desc:'ê°œë… í™•ì¸ í€´ì¦ˆ', type:'quiz' },
    { icon:'â­', name:'ìˆ˜ì—… ë§Œì¡±ë„', desc:'ê°•ì˜ í‰ê°€', type:'rating', q:'ì˜¤ëŠ˜ ê°•ì˜ì˜ ë§Œì¡±ë„ëŠ”?' },
    { icon:'ğŸ“ˆ', name:'ì´í•´ë„ ìŠ¬ë¼ì´ë”', desc:'ì´í•´ ì •ë„ ì¸¡ì •', type:'slider', q:'ì´ ì£¼ì œë¥¼ ì–¼ë§ˆë‚˜ ì´í•´í–ˆë‚˜ìš”?' },
  ],
  biz: [
    { icon:'ğŸ—³ï¸', name:'ì˜ì‚¬ê²°ì • íˆ¬í‘œ', desc:'ë¹ ë¥¸ ì˜ê²¬ ìˆ˜ë ´', type:'poll', q:'ì–´ë–¤ ë°©í–¥ìœ¼ë¡œ ì§„í–‰í• ê¹Œìš”?', opts:['ë°©ì•ˆ A â€” ë¹ ë¥¸ ì¶œì‹œ','ë°©ì•ˆ B â€” í’ˆì§ˆ ìš°ì„ ','ë°©ì•ˆ C â€” ì¶”ê°€ ê²€í† '] },
    { icon:'ğŸ’¡', name:'ë¸Œë ˆì¸ìŠ¤í†°', desc:'íŒ€ ì•„ì´ë””ì–´ ìˆ˜ì§‘', type:'wordcloud', q:'ì´ë²ˆ í”„ë¡œì íŠ¸ì˜ í•µì‹¬ ê°€ì¹˜ëŠ”?' },
    { icon:'â“', name:'íŒ€ Q&A', desc:'ìµëª… ì˜ê²¬ ìˆ˜ë ´', type:'qa', q:'ì´ ê³„íšì— ëŒ€í•œ ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš”' },
    { icon:'ğŸ¯', name:'ì „ëµ í€´ì¦ˆ', desc:'ì „ëµ ì´í•´ë„ í™•ì¸', type:'quiz' },
    { icon:'â­', name:'ë°œí‘œ í”¼ë“œë°±', desc:'ë°œí‘œ í‰ê°€', type:'rating', q:'ì´ë²ˆ ë°œí‘œì˜ ì „ë°˜ì ì¸ ì™„ì„±ë„ëŠ”?' },
    { icon:'ğŸ“Š', name:'ìš°ì„ ìˆœìœ„ íˆ¬í‘œ', desc:'ì¤‘ìš”ë„ ì¸¡ì •', type:'slider', q:'ì´ ê¸°ëŠ¥ì˜ ìš°ì„ ìˆœìœ„ëŠ” ì–´ëŠ ì •ë„ì¸ê°€ìš”?' },
  ],
  evt: [
    { icon:'ğŸ‰', name:'ê´€ê° íˆ¬í‘œ', desc:'ë¼ì´ë¸Œ íˆ¬í‘œ', type:'poll', q:'ì˜¤ëŠ˜ ì´ë²¤íŠ¸ì— ê¸°ëŒ€í•˜ëŠ” ê²ƒì€?', opts:['ë„¤íŠ¸ì›Œí‚¹','ìƒˆë¡œìš´ ì •ë³´','ì—”í„°í…Œì¸ë¨¼íŠ¸','ì˜ê°'] },
    { icon:'ğŸŒŸ', name:'ì•„ì´ìŠ¤ë¸Œë ˆì´ì»¤', desc:'ì°¸ì—¬ì ì†Œê°œ', type:'wordcloud', q:'ì˜¤ëŠ˜ ì—¬ëŸ¬ë¶„ì„ í•œ ë‹¨ì–´ë¡œ í‘œí˜„í•˜ë©´?' },
    { icon:'â“', name:'ì²­ì¤‘ Q&A', desc:'ì²­ì¤‘ ì§ˆë¬¸ ìˆ˜ì§‘', type:'qa', q:'ì—°ì‚¬ì—ê²Œ ì§ˆë¬¸ì„ ì˜¬ë ¤ì£¼ì„¸ìš”' },
    { icon:'ğŸ†', name:'ë¼ì´ë¸Œ í€´ì¦ˆ', desc:'ê´€ê° í€´ì¦ˆ ê²Œì„', type:'quiz' },
    { icon:'â­', name:'ì´ë²¤íŠ¸ í‰ê°€', desc:'í–‰ì‚¬ ë§Œì¡±ë„', type:'rating', q:'ì´ë²ˆ ì´ë²¤íŠ¸ ë§Œì¡±ë„ëŠ”?' },
    { icon:'ğŸ˜Š', name:'ë¶„ìœ„ê¸° ì²´í¬', desc:'í˜„ì¬ ê¸°ë¶„ ì¸¡ì •', type:'slider', q:'í˜„ì¬ ì´ë²¤íŠ¸ì˜ ë¶„ìœ„ê¸°ëŠ” ì–´ë–¤ê°€ìš”?' },
  ]
};

let pollData = { q:'', opts:[], votes:[] };
let pollLive = false;
let wcData = {};
const wcPalette = [
  {bg:'#e8f5ee',txt:'#1a5c42'},{bg:'#eef1fb',txt:'#1a3080'},
  {bg:'#fbeef5',txt:'#8b1d57'},{bg:'#fdf3e8',txt:'#7a3a10'},
  {bg:'#eef8ff',txt:'#0a4d8c'},{bg:'#fdf5ff',txt:'#5c1a8c'},
  {bg:'#fff8ea',txt:'#7a5010'},{bg:'#eafcf8',txt:'#0a5c4a'},
];
let qaItems = [];
let qaNextId = 1;
let qaFilter = 'all';

const quizzes = {
  edu: [
    {q:'ê°ì²´ ì§€í–¥ í”„ë¡œê·¸ë˜ë°ì˜ í•µì‹¬ ê°œë…ì´ ì•„ë‹Œ ê²ƒì€?',opts:['ìº¡ìŠí™”','ìƒì†','ì¬ê·€','ë‹¤í˜•ì„±'],correct:2},
    {q:'HTTP ë©”ì„œë“œ ì¤‘ ë°ì´í„°ë¥¼ ìƒì„±í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒì€?',opts:['GET','POST','PUT','DELETE'],correct:1},
    {q:'CSSì—ì„œ ìš”ì†Œë¥¼ ê°€ìš´ë° ì •ë ¬í•˜ëŠ” ê°€ì¥ í˜„ëŒ€ì ì¸ ë°©ë²•ì€?',opts:['float:center','margin:0 auto + width','Flexbox / Grid','text-align:center'],correct:2},
    {q:'Gitì—ì„œ ë³€ê²½ ì‚¬í•­ì„ ì„ì‹œ ì €ì¥í•˜ëŠ” ëª…ë ¹ì–´ëŠ”?',opts:['git save','git stash','git commit','git store'],correct:1},
    {q:'JavaScriptì—ì„œ ë¶ˆë³€(immutable) ë³€ìˆ˜ ì„ ì–¸ í‚¤ì›Œë“œëŠ”?',opts:['var','let','const','static'],correct:2},
  ],
  biz: [
    {q:'OKRì—ì„œ "KR"ì€ ë¬´ì—‡ì˜ ì•½ìì¸ê°€ìš”?',opts:['Key Resources','Key Results','Key Roadmap','Key Revenue'],correct:1},
    {q:'ì• ìì¼ ìŠ¤í”„ë¦°íŠ¸ì˜ ê°€ì¥ ì¼ë°˜ì ì¸ ê¸°ê°„ì€?',opts:['1ì¼','1ì£¼ì¼','2ì£¼ì¼','1ê°œì›”'],correct:2},
    {q:'ê³ ê° ì—¬ì • ì§€ë„ì˜ ì£¼ìš” ëª©ì ì€?',opts:['ë§¤ì¶œ ì¶”ì ','ê³ ê° ê²½í—˜ ì‹œê°í™”','íŒ€ ê´€ë¦¬','ì œí’ˆ ê°œë°œ'],correct:1},
    {q:'NPSì˜ ì¸¡ì • ë²”ìœ„ëŠ”?',opts:['-100 ~ 100','0 ~ 100','1 ~ 10','0 ~ 10'],correct:0},
    {q:'SWOT ë¶„ì„ì—ì„œ "O"ëŠ”?',opts:['Organization','Opportunities','Output','Operations'],correct:1},
  ],
  evt: [
    {q:'ì„¸ê³„ì—ì„œ ê°€ì¥ ë§ì´ ì‚¬ìš©ë˜ëŠ” SNS í”Œë«í¼ì€?',opts:['Instagram','TikTok','Facebook','YouTube'],correct:2},
    {q:'ChatGPTë¥¼ ê°œë°œí•œ íšŒì‚¬ëŠ”?',opts:['Google','Microsoft','OpenAI','Meta'],correct:2},
    {q:'"ë©”íƒ€ë²„ìŠ¤"ë¼ëŠ” ìš©ì–´ë¥¼ ì²˜ìŒ ì‚¬ìš©í•œ ì†Œì„¤ì€?',opts:['ë‰´ë¡œë§¨ì„œ','ìŠ¤ë…¸ìš° í¬ë˜ì‹œ','ë ˆë”” í”Œë ˆì´ì–´ ì›','ë¸Œë ˆì´ë¸Œ ë‰´ ì›”ë“œ'],correct:1},
    {q:'ì„¸ê³„ ìµœì´ˆ ìƒì—…ìš© ì›¹ì‚¬ì´íŠ¸ ë“±ì¥ ì—°ë„ëŠ”?',opts:['1989','1991','1993','1995'],correct:2},
    {q:'í˜„ì¬ ì „ ì„¸ê³„ ì¸í„°ë„· ì‚¬ìš©ì ìˆ˜ëŠ”?',opts:['10ì–µ ëª…','20ì–µ ëª…','30ì–µ ëª…','50ì–µ ëª…'],correct:3},
  ]
};

let quizIdx=0, quizScore=0, quizAnswered=false;
let ratings=[], sliderResponses=[];

// ============================================================
//   FIREBASE HELPERS
// ============================================================
function fbPath(path) { return `sessions/${roomCode}/${path}`; }

async function fbSet(path, value) {
  if (db && roomCode) { try { await db.ref(fbPath(path)).set(value); return true; } catch(e){} }
  return false;
}

async function fbTransaction(path, fn) {
  if (db && roomCode) { try { await db.ref(fbPath(path)).transaction(fn); return true; } catch(e){} }
  return false;
}

function fbPush(path, value) {
  if (db && roomCode) { try { return db.ref(fbPath(path)).push(value); } catch(e){} }
  return null;
}

function fbOn(path, event, cb) {
  if (db && roomCode) {
    const ref = db.ref(fbPath(path));
    ref.on(event, cb);
    fbListeners.push({ref, event, cb});
    return ref;
  }
  return null;
}

function fbOffAll() {
  fbListeners.forEach(({ref,event,cb}) => ref.off(event,cb));
  fbListeners = [];
}

function setFbStatus(status) {
  const dot = document.getElementById('fbStatusDot');
  const lbl = document.getElementById('fbStatusLabel');
  if (!dot||!lbl) return;
  dot.className = 'fb-status '+status;
  lbl.textContent = status==='connected'?'ì‹¤ì‹œê°„ ì—°ê²°ë¨':status==='demo'?'ë°ëª¨ ëª¨ë“œ':'ì—°ê²° ëŠê¹€';
}

// ============================================================
//   SESSION SETUP
// ============================================================
async function initHostSession(c, initialAct) {
  isHost = true;
  if (db) {
    await db.ref(fbPath('')).set({
      ctx:c, title: sessionTitle || '', hostKey: hostKey || '', createdAt:Date.now(), active:true,
      participants:0, responses:0, activeActivity:(initialAct||'poll'),
      poll:{live:false,q:'',opts:[],votes:{}}, wordcloud:{}, rating:[], slider:[]
    });

    // Listeners
    fbOn('participants','value', s=>{ totalParticipants=s.val()||0; updateStats(); });
    attachParticipantMetaListeners();
    fbOn('nicknames','value', s=>{ participantNames = s.val()||{}; renderParticipantNames(); });
    fbOn('responses','value', s=>{ totalResponses=s.val()||0; updateStats(); });

    fbOn('poll','value', s=>{
      const d=s.val(); if(!d) return;
      pollLive=d.live||false;
      if(d.live&&d.opts){ const v=d.votes||{}; pollData={q:d.q,opts:d.opts,votes:d.opts.map((_,i)=>v[i]||0)}; if(document.getElementById('poll-result-card')?.style.display!=='none') renderPollBars(); }
    });

    fbOn('wordcloud','value', s=>{
      wcData=s.val()||{}; if(document.getElementById('ap-wordcloud')?.classList.contains('active')){ renderWC(); updateCount('cnt-wc',Object.keys(wcData).length); }
    });

    fbOn('qa','child_added', s=>{
      const item={...s.val(),id:s.key,voted:false};
      if(!qaItems.find(i=>i.id===s.key)){ qaItems.push(item); totalQuestions=qaItems.length; updateStats(); renderQA(); addFeed(`ìƒˆ ì§ˆë¬¸: "${item.q.slice(0,28)}..."`, 'var(--theme-a)'); }
    });

    fbOn('qa','child_changed', s=>{
      const idx=qaItems.findIndex(i=>i.id===s.key);
      if(idx>=0){ qaItems[idx]={...qaItems[idx],...s.val(),id:s.key}; renderQA(); }
    });

    fbOn('rating','value', s=>{
      ratings=s.val()||[]; if(document.getElementById('ap-rating')?.classList.contains('active')){ updateRatingResult(); updateCount('cnt-rating',ratings.length); }
    });

    fbOn('slider','value', s=>{
      sliderResponses=s.val()||[]; if(document.getElementById('ap-slider')?.classList.contains('active')){ renderSliderResults(); updateCount('cnt-slider',sliderResponses.length); }
    });

    db.ref('.info/connected').on('value', s=>setFbStatus(s.val()?'connected':'offline'));
    setFbStatus('connected');
    addFeed('ğŸ”¥ Firebase ì‹¤ì‹œê°„ ì—°ê²°ë¨', '#22c55e');
  } else {
    setFbStatus('demo');
    setTimeout(()=>{ totalParticipants=Math.floor(Math.random()*20)+5; updateStats(); addFeed(`ì„¸ì…˜ ì‹œì‘ (ë°ëª¨): ${roomCode}`,'var(--theme-a)'); addFeed(`${totalParticipants}ëª… ì…ì¥`,'#22a05a'); },600);
  }
}

async function joinSessionFirebase(code) {
  if (!db) return false;
  try {
    const snap = await db.ref(`sessions/${code}`).once('value');
    if (!snap.exists()||!snap.val().active) return false;
    roomCode=code; ctx=snap.val().ctx||'edu'; isHost=false;
    setParticipantSessionTitle(snap.val().title||'');
    // Keep participant header title synced
    db.ref(`sessions/${code}/title`).on('value', s=>setParticipantSessionTitle(s.val()||''));
    await db.ref(`sessions/${code}/participants`).transaction(n=>(n||0)+1);
    db.ref(`sessions/${code}/activeActivity`).on('value', s=>{ if(s.val()) updateParticipantView(s.val()); });
    db.ref(`sessions/${code}/poll`).on('value', s=>{
      const d=s.val(); if(d&&d.live){ document.getElementById('pTitle').textContent=d.q; document.getElementById('pContent').innerHTML=(d.opts||[]).map((o,i)=>`<button class="v-btn" style="width:100%;margin-bottom:8px" onclick="participantVote('${code}',${i},'${o}')">${o}</button>`).join(''); }
    });
    return true;
  } catch(e) { return false; }
}

async function participantVote(code,optIdx,optName) {
  if (!db) return;
  await db.ref(`sessions/${code}/poll/votes/${optIdx}`).transaction(n=>(n||0)+1);
  await db.ref(`sessions/${code}/responses`).transaction(n=>(n||0)+1);
  document.querySelectorAll('#pContent .v-btn').forEach(b=>{b.disabled=true;b.style.opacity='0.5';});
  addFeed(`"${optName}" ì— íˆ¬í‘œí–ˆìŠµë‹ˆë‹¤`,'#22a05a');
}

// ============================================================
//   UTILITIES
// ============================================================
function genCode() {
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let c=''; for(let i=0;i<3;i++) c+=chars[Math.floor(Math.random()*chars.length)];
  c+='-'; for(let i=0;i<3;i++) c+=chars[Math.floor(Math.random()*chars.length)];
  return c;
}

function setTheme(c) {
  const map={
    light:{edu:['#2d7a5a','#1a3a2e','#e8f5ee','linear-gradient(135deg,#2d7a5a,#1a5c42)'],biz:['#2b4bbf','#1a1f3a','#eef1fb','linear-gradient(135deg,#2b4bbf,#1a3080)'],evt:['#c2337a','#3a1a2e','#fbeef5','linear-gradient(135deg,#c2337a,#8b1d57)']},
    dark:{edu:['#3dba80','#1a3a2e','rgba(45,122,90,0.15)','linear-gradient(135deg,#3dba80,#2d7a5a)'],biz:['#5b79ef','#1a1f3a','rgba(43,75,191,0.15)','linear-gradient(135deg,#5b79ef,#2b4bbf)'],evt:['#e84da0','#3a1a2e','rgba(194,51,122,0.15)','linear-gradient(135deg,#e84da0,#c2337a)']},
    vivid:{edu:['#00b894','#004d3a','#e0fff8','linear-gradient(135deg,#00b894,#00796b)'],biz:['#6c5ce7','#1e0a5e','#ede7ff','linear-gradient(135deg,#6c5ce7,#4a00b4)'],evt:['#fd79a8','#5e0033','#fff0f7','linear-gradient(135deg,#fd79a8,#e84393)']}
  };
  const mode=currentUiMode||'light';
  const [a,h,l,g]=(map[mode]||map.light)[c]||map.light[c];
  document.documentElement.style.setProperty('--theme-a',a);
  document.documentElement.style.setProperty('--theme-h',h);
  document.documentElement.style.setProperty('--theme-l',l);
  document.documentElement.style.setProperty('--theme-g',g);
}

function now() { const d=new Date(); return `${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`; }

function addFeed(text,color) {
  const feed=document.getElementById('liveFeed'); if(!feed) return;
  const item=document.createElement('div'); item.className='feed-item';
  item.innerHTML=`<div class="feed-dot" style="background:${color}"></div><div class="feed-txt">${text}</div><div class="feed-time">${now()}</div>`;
  feed.prepend(item); while(feed.children.length>10) feed.removeChild(feed.lastChild);
}

function updateStats() {
  const pEl=document.getElementById('statPart'); if(pEl) pEl.textContent=totalParticipants;
  const rEl=document.getElementById('statResp'); if(rEl) rEl.textContent=totalResponses;
  const qEl=document.getElementById('statQ'); if(qEl) qEl.textContent=totalQuestions;
  const pct=totalParticipants>0?Math.min(100,Math.round(totalResponses/totalParticipants*100)):0;
  const epEl=document.getElementById('engPct'); if(epEl) epEl.textContent=pct+'%';
  const ebEl=document.getElementById('engBar'); if(ebEl) ebEl.style.width=pct+'%';
  const fill=document.getElementById('ringFill');
  if(fill) fill.style.strokeDashoffset=213.6*(1-Math.min(1,totalParticipants/100));
}

function updateCount(id,val) { const el=document.getElementById(id); if(el) el.textContent=val; }

// ============================================================
//   NAVIGATION
// ============================================================
function goHome() { fbOffAll(); showQAFab(false);
    showScreen('landing'); }
function scrollToJoin() { document.getElementById('join-section').scrollIntoView({behavior:'smooth'}); }
function showScreen(name) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById('screen-'+name).classList.add('active'); }
function goToSetup() { startAsHost('edu','poll'); }

let hostKey = localStorage.getItem('actively_hostKey') || (Date.now().toString(36)+Math.random().toString(36).slice(2,8));
localStorage.setItem('actively_hostKey', hostKey);
let sessionTitle = '';

async function startAsHost(c, initialAct, title) {
  ctx=c; setTheme(c); roomCode=genCode();
  sessionTitle = (title||'').toString().trim();
  setTopTitle(sessionTitle);
  const initAct = initialAct || 'poll';
  document.getElementById('navRoomCode').textContent=roomCode;
  document.getElementById('qrCode').textContent=roomCode;
  document.getElementById('navCtxPill').textContent=ctxConfig[c].label;
  // QR ì½”ë“œ ìƒì„± & ë§í¬ í‘œì‹œ
  const joinUrl = 'https://actively1.netlify.app?join=' + roomCode;
  const linkDisplay = document.getElementById('joinLinkDisplay');
  if (linkDisplay) linkDisplay.textContent = joinUrl;
  setTimeout(() => drawQR(joinUrl), 300);
  loadTemplates(); loadContextDefaults(); showScreen('host');
  totalParticipants=0; totalResponses=0; totalQuestions=0;
  qaItems=[]; wcData={}; ratings=[]; sliderResponses=[];
  updateStats(); renderQuiz(); renderQA(); renderSliderResults();
  // open requested activity panel
  switchActivity(initAct, null);
  await initHostSession(c, initAct);
  // Keep top title synced (host)
  if(FIREBASE_READY && db && roomCode){
    db.ref(`sessions/${roomCode}/title`).on('value', s=>setTopTitle(s.val()||sessionTitle||''));
  }
  if(!FIREBASE_READY) {
    setInterval(()=>{ if(Math.random()<0.15){ totalParticipants+=Math.floor(Math.random()*3)+1; updateStats(); addFeed('ì°¸ì—¬ìê°€ ì…ì¥í–ˆìŠµë‹ˆë‹¤','#22a05a'); } },4000);
  }
}

async function joinSession() {
  const input=document.getElementById('joinCodeInput');
  const code=input.value.trim().toUpperCase().replace(/[^A-Z0-9-]/g,'');
  if(!code) return;
  if(FIREBASE_READY) {
    const btn=document.querySelector('.btn-join'); btn.textContent='ì—°ê²° ì¤‘...';
    const ok=await joinSessionFirebase(code); btn.textContent='ì°¸ì—¬ â†’';
    if(ok) { setTheme(ctx); document.getElementById('pContextLabel').textContent=ctxConfig[ctx]?.label||'ì„¸ì…˜'; showScreen('participant'); }
    else { input.style.borderColor='#e05050'; input.placeholder='ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”'; setTimeout(()=>{input.style.borderColor='';input.placeholder='ABC-123';},2000); }
  } else {
    alert(`ì½”ë“œ "${code}" â€” Firebase ë¯¸ì„¤ì • ìƒíƒœì…ë‹ˆë‹¤.\n\nSETUP_GUIDE.md ë¥¼ ì°¸ê³ í•´ Firebaseë¥¼ ì—°ê²°í•´ ì£¼ì„¸ìš”.`);
  }
}

function loadContextDefaults() {
  const defaults={
    edu:{pollQ:'ì˜¤ëŠ˜ ê°•ì˜ì—ì„œ ê°€ì¥ ì–´ë ¤ì› ë˜ ë¶€ë¶„ì€?',pollOpts:['ê°œë… ì´í•´','ì½”ë“œ ì‹¤ìŠµ','Q&A ì‹œê°„','ì—†ìŒ (ëª¨ë‘ ì´í•´í–ˆì–´ìš”)'],wcPrompt:'ì˜¤ëŠ˜ ê°•ì˜ë¥¼ í•œ ë‹¨ì–´ë¡œ!',ratingQ:'ì˜¤ëŠ˜ ê°•ì˜ì˜ ë§Œì¡±ë„ëŠ”?',sliderQ:'ì´ ì£¼ì œë¥¼ ì–¼ë§ˆë‚˜ ì´í•´í–ˆë‚˜ìš”?',sliderMin:'ì „í˜€ ëª¨ë¥´ê² ì–´ìš”',sliderMax:'ì™„ë²½íˆ ì´í•´í–ˆì–´ìš”'},
    biz:{pollQ:'ì´ ì•ˆê±´ì— ëŒ€í•œ ì˜ê²¬ì€?',pollOpts:['ê°•ë ¥ ì°¬ì„±','ì°¬ì„±','ì¤‘ë¦½','ë°˜ëŒ€'],wcPrompt:'ì´ë²ˆ ë¶„ê¸°ì˜ í•µì‹¬ í‚¤ì›Œë“œëŠ”?',ratingQ:'ì´ë²ˆ ë°œí‘œì˜ ì™„ì„±ë„ëŠ”?',sliderQ:'ì´ ì „ëµì˜ ì‹¤í˜„ ê°€ëŠ¥ì„±ì€?',sliderMin:'ë§¤ìš° ì–´ë ¤ì›€',sliderMax:'ì¶©ë¶„íˆ ê°€ëŠ¥'},
    evt:{pollQ:'ì˜¤ëŠ˜ ì´ë²¤íŠ¸ì—ì„œ ê¸°ëŒ€í•˜ëŠ” ê²ƒì€?',pollOpts:['ë„¤íŠ¸ì›Œí‚¹','ìƒˆë¡œìš´ ì •ë³´','ì—”í„°í…Œì¸ë¨¼íŠ¸','ì˜ê°'],wcPrompt:'ì˜¤ëŠ˜ ì´ë²¤íŠ¸ë¥¼ í•œ ë‹¨ì–´ë¡œ!',ratingQ:'ì´ë²ˆ ì´ë²¤íŠ¸ì˜ ë§Œì¡±ë„ëŠ”?',sliderQ:'í˜„ì¬ ì´ë²¤íŠ¸ ë¶„ìœ„ê¸°ëŠ”?',sliderMin:'ì¡°ìš©í•´ìš”',sliderMax:'ë§¤ìš° í™œê¸°ì°¨ìš”'},
  };
  const d=defaults[ctx]; if(!d) return;
  const qEl=document.getElementById('pollQ'); if(qEl) qEl.value=d.pollQ;
  const opts=document.getElementById('pollOpts');
  if(opts){ opts.innerHTML=''; d.pollOpts.forEach(o=>{ const row=document.createElement('div'); row.className='opt-row'; row.innerHTML=`<input type="text" class="form-input" value="${o}"><button class="btn-opt-remove" onclick="rmOpt(this)">Ã—</button>`; opts.appendChild(row); }); }
  if(document.getElementById('wcPrompt')) document.getElementById('wcPrompt').value=d.wcPrompt;
  if(document.getElementById('ratingQ')){ document.getElementById('ratingQ').value=d.ratingQ; document.getElementById('ratingQDisplay').textContent=d.ratingQ; }
  if(document.getElementById('sliderQ')){ document.getElementById('sliderQ').value=d.sliderQ; document.getElementById('sliderQDisplay').textContent=d.sliderQ; }
  if(document.getElementById('sliderMin')){ document.getElementById('sliderMin').value=d.sliderMin; document.getElementById('sliderMinLbl').textContent=d.sliderMin; }
  if(document.getElementById('sliderMax')){ document.getElementById('sliderMax').value=d.sliderMax; document.getElementById('sliderMaxLbl').textContent=d.sliderMax; }
}

function loadTemplates() {
  const list=document.getElementById('templateList'); list.innerHTML='';
  (templates[ctx]||[]).forEach(t=>{ const item=document.createElement('div'); item.className='template-item'; item.innerHTML=`<div class="t-icon">${t.icon}</div><div><div class="t-name">${t.name}</div><div class="t-desc">${t.desc}</div></div>`; item.onclick=()=>applyTemplate(t); list.appendChild(item); });
}

function applyTemplate(t) {
  switchActivity(t.type,null);
  if(t.type==='poll'&&t.q){ document.getElementById('pollQ').value=t.q; if(t.opts){ const c=document.getElementById('pollOpts'); c.innerHTML=''; t.opts.forEach(o=>{ const row=document.createElement('div'); row.className='opt-row'; row.innerHTML=`<input type="text" class="form-input" value="${o}"><button class="btn-opt-remove" onclick="rmOpt(this)">Ã—</button>`; c.appendChild(row); }); } document.getElementById('poll-edit-card').style.display=''; document.getElementById('poll-result-card').style.display='none'; pollLive=false; }
  else if(t.type==='wordcloud'&&t.q) document.getElementById('wcPrompt').value=t.q;
  else if(t.type==='rating'&&t.q){ document.getElementById('ratingQ').value=t.q; document.getElementById('ratingQDisplay').textContent=t.q; }
  else if(t.type==='slider'&&t.q){ document.getElementById('sliderQ').value=t.q; document.getElementById('sliderQDisplay').textContent=t.q; }
  addFeed(`í…œí”Œë¦¿ "${t.name}" ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤`,'var(--muted)');
}

function switchActivity(act,btn) {
  document.querySelectorAll('.activity-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('ap-'+act).classList.add('active');
  document.querySelectorAll('.act-btn,.nav-tab').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  const acts=['poll','wordcloud','qa','quiz','rating','slider'];
  const idx=acts.indexOf(act);
  const actBtns=document.querySelectorAll('#actNav .act-btn');
  if(actBtns[idx]) actBtns[idx].classList.add('active');
  const navTabs=document.querySelectorAll('.nav-tabs .nav-tab');
  if(navTabs[idx]) navTabs[idx].classList.add('active');
  if(isHost&&db&&roomCode) db.ref(fbPath('activeActivity')).set(act);
}

// ============================================================
//   POLL
// ============================================================
function addOpt() { const row=document.createElement('div'); row.className='opt-row'; row.innerHTML=`<input type="text" class="form-input" placeholder="ìƒˆ ì„ íƒì§€"><button class="btn-opt-remove" onclick="rmOpt(this)">Ã—</button>`; document.getElementById('pollOpts').appendChild(row); }
function rmOpt(btn) { if(document.querySelectorAll('#pollOpts .opt-row').length>2) btn.parentElement.remove(); }

async function launchPoll() {
  const q=document.getElementById('pollQ').value.trim();
  const opts=Array.from(document.querySelectorAll('#pollOpts input')).map(i=>i.value.trim()).filter(Boolean);
  if(!q||opts.length<2) return;
  pollData={q,opts,votes:opts.map(()=>0)}; pollLive=true;
  const ok=await fbSet('poll',{live:true,q,opts,votes:opts.reduce((acc,_,i)=>({...acc,[i]:0}),{})});
  addFeed(ok?`ğŸ”¥ íˆ¬í‘œ Firebase ê²Œì‹œë¨: "${q}"`:`íˆ¬í‘œ ì‹œì‘: "${q}"`,'var(--theme-a)');
  document.getElementById('poll-edit-card').style.display='none';
  document.getElementById('poll-result-card').style.display='';
  document.getElementById('pr-question').textContent=q;
  renderPollBars(); updateCount('cnt-poll',0);
}

function renderPollBars() {
  const total=pollData.votes.reduce((a,b)=>a+b,0);
  document.getElementById('pr-meta').textContent=`${total}í‘œ ì§‘ê³„ë¨`;
  updateCount('cnt-poll',total);
  const c=document.getElementById('pr-bars'); c.innerHTML='';
  pollData.opts.forEach((opt,i)=>{ const pct=total>0?Math.round(pollData.votes[i]/total*100):0; const item=document.createElement('div'); item.className='result-bar-item'; item.innerHTML=`<div class="result-bar-label"><span>${opt}</span><span class="pct">${pct}%</span></div><div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>`; c.appendChild(item); });
  const grid=document.createElement('div'); grid.className='vote-grid';
  pollData.opts.forEach((opt,i)=>{ const b=document.createElement('button'); b.className='v-btn'; b.textContent=opt; b.onclick=async()=>{ const wrote=await fbTransaction(`poll/votes/${i}`,n=>(n||0)+1); if(!wrote){pollData.votes[i]++;totalResponses++;updateStats();renderPollBars();} addFeed(`"${opt}" ì— íˆ¬í‘œ`,'#22a05a'); }; grid.appendChild(b); });
  c.appendChild(grid);
}

async function simulateVotes() {
  if(!pollLive) await launchPoll();
  const n=Math.floor(Math.random()*8)+3;
  for(let i=0;i<n;i++){ const idx=Math.floor(Math.random()*pollData.opts.length); await fbTransaction(`poll/votes/${idx}`,v=>(v||0)+1); if(!FIREBASE_READY) pollData.votes[idx]++; }
  if(!FIREBASE_READY){totalResponses+=n;updateStats();renderPollBars();}
  addFeed(`${n}ê°œ í…ŒìŠ¤íŠ¸ íˆ¬í‘œ ì¶”ê°€ë¨`,'var(--muted)');
}

async function resetPoll() { const ev=pollData.opts.reduce((acc,_,i)=>({...acc,[i]:0}),{}); await fbSet('poll/votes',ev); if(!FIREBASE_READY){pollData.votes=pollData.opts.map(()=>0);renderPollBars();} updateCount('cnt-poll',0); }
function editPoll() { pollLive=false; document.getElementById('poll-edit-card').style.display=''; document.getElementById('poll-result-card').style.display='none'; if(db&&roomCode) db.ref(fbPath('poll/live')).set(false); }

// ============================================================
//   WORD CLOUD
// ============================================================
async function addWcWord() {
  const input=document.getElementById('wcInput');
  const w=input.value.trim().toLowerCase().replace(/\s+/g,'_');
  if(!w) return; input.value='';
  const wrote=await fbTransaction(`wordcloud/${w}`,n=>(n||0)+1);
  if(!wrote){wcData[w]=(wcData[w]||0)+1;renderWC();totalResponses++;updateStats();}
  updateCount('cnt-wc',Object.keys(wcData).length);
  addFeed(`ë‹¨ì–´ "${w.replace(/_/g,' ')}" ì¶”ê°€ë¨`,'var(--theme-a)');
}

document.addEventListener('keypress',e=>{ if(e.key==='Enter'&&document.activeElement.id==='wcInput') addWcWord(); if(e.key==='Enter'&&document.activeElement.id==='qaIn') addQA(); if(e.key==='Enter'&&document.activeElement.id==='joinCodeInput') joinSession(); });

function renderWC() {
  const c=document.getElementById('wcCanvas'); c.innerHTML='';
  const sorted=Object.entries(wcData).sort((a,b)=>b[1]-a[1]);
  if(!sorted.length){c.innerHTML='<span style="color:var(--muted);font-size:13px">ì•„ì§ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤</span>';return;}
  const max=sorted[0][1];
  sorted.forEach(([word,count],i)=>{ const size=13+Math.round((count/max)*28); const pal=wcPalette[i%wcPalette.length]; const tag=document.createElement('div'); tag.className='wc-word'; tag.textContent=word.replace(/_/g,' '); tag.style.cssText=`font-size:${size}px;background:${pal.bg};color:${pal.txt};`; c.appendChild(tag); });
}

const demoWordSets={edu:['React','JavaScript','CSS','API','ì»´í¬ë„ŒíŠ¸','í›…','ìƒíƒœê´€ë¦¬','ë¹„ë™ê¸°','REST','TypeScript'],biz:['í˜ì‹ ','ì„±ì¥','ì „ëµ','í˜‘ë ¥','ë””ì§€í„¸','ê³ ê°','ë°ì´í„°','ë¦°','ì• ìì¼','ìŠ¤ì¼€ì¼'],evt:['ë„¤íŠ¸ì›Œí‚¹','ì˜ê°','ë¯¸ë˜','ì—°ê²°','ì»¤ë®¤ë‹ˆí‹°','ê¸°ìˆ ','ê¸°íšŒ','ë³€í™”','ì—´ì •','í˜‘ì—…']};

async function loadDemoWords() {
  const words=demoWordSets[ctx]||demoWordSets.edu;
  const updates={}; words.forEach(w=>{updates[w.toLowerCase()]=Math.floor(Math.random()*8)+1;});
  const wrote=await fbSet('wordcloud',updates);
  if(!wrote){wcData={...updates};renderWC();}
  updateCount('cnt-wc',words.length);
}

async function clearWords() { await fbSet('wordcloud',null); if(!FIREBASE_READY){wcData={};renderWC();} updateCount('cnt-wc',0); }

// ============================================================
//   Q&A
// ============================================================
async function addQA() {
  const inp=document.getElementById('qaIn'); const q=inp.value.trim(); if(!q) return; inp.value='';
  const newItem={q,votes:0,answered:false,timestamp:Date.now()};
  const ref=fbPush('qa',newItem);
  if(!ref){qaItems.push({...newItem,id:'local_'+qaNextId++,voted:false});totalQuestions++;updateStats();renderQA();}
  addFeed('ìƒˆ ì§ˆë¬¸ ë“±ë¡ë¨','var(--theme-a)');
}

function renderQA() {
  const list=document.getElementById('qaList'); if(!list) return;
  list.innerHTML='';
  let filtered=[...qaItems];
  if(qaFilter==='answered') filtered=filtered.filter(i=>i.answered);
  if(qaFilter==='unanswered') filtered=filtered.filter(i=>!i.answered);
  filtered.sort((a,b)=>b.votes-a.votes);
  if(!filtered.length){list.innerHTML=`<div style="text-align:center;padding:24px;color:var(--muted);font-size:13px">ì•„ì§ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</div>`;return;}
  filtered.forEach(item=>{ const div=document.createElement('div'); div.className='qa-card'+(item.answered?' answered':''); div.innerHTML=`<div class="qa-q">${item.q}</div><div class="qa-footer"><div class="qa-author">ìµëª…</div><div class="qa-actions"><button class="up-btn ${item.voted?'voted':''}" onclick="upvote('${item.id}')">â–² ${item.votes}</button>${item.answered?'<span class="answered-tag">âœ“ ë‹µë³€ ì™„ë£Œ</span>':`<button class="mark-answered-btn" onclick="markAnswered('${item.id}')">ë‹µë³€ ì™„ë£Œ</button>`}</div></div>`; list.appendChild(div); });
  updateCount('cnt-qa',qaItems.length); totalQuestions=qaItems.length; updateStats();
}

async function upvote(id) {
  const item=qaItems.find(i=>i.id===id); if(!item) return;
  if(item.voted){item.votes--;item.voted=false;await fbTransaction(`qa/${id}/votes`,n=>Math.max(0,(n||0)-1));}
  else{item.votes++;item.voted=true;await fbTransaction(`qa/${id}/votes`,n=>(n||0)+1);}
  renderQA();
}

async function markAnswered(id) {
  const item=qaItems.find(i=>i.id===id); if(!item) return;
  item.answered=true; await fbSet(`qa/${id}/answered`,true); renderQA(); addFeed('ì§ˆë¬¸ì— ë‹µë³€ ì™„ë£Œ í‘œì‹œ','#22a05a');
}

function filterQA(f) {
  qaFilter=f;
  ['all','unanswered','answered'].forEach(x=>{const btn=document.getElementById('qa-filter-'+x);if(btn){btn.style.borderColor=x===f?'var(--theme-a)':'';btn.style.color=x===f?'var(--theme-a)':'';}});
  renderQA();
}

// ============================================================
//   QUIZ
// ============================================================
function renderQuiz() {
  const body=document.getElementById('quizBody'); if(!body) return;
  const qs=quizzes[ctx]||quizzes.edu;
  if(quizIdx>=qs.length){ const pct=Math.round(quizScore/qs.length*100); body.innerHTML=`<div class="quiz-result"><div class="quiz-result-score" style="color:var(--theme-a)">${quizScore}/${qs.length}</div><div class="quiz-result-label">${pct>=80?'ğŸ† í›Œë¥­í•©ë‹ˆë‹¤!':pct>=60?'ğŸ‘ ì˜ í•˜ì…¨ì–´ìš”!':'ğŸ’ª ë‹¤ì‹œ ë„ì „!'}</div><div style="font-size:14px;color:var(--muted);margin-bottom:24px">ì •ë‹µë¥  ${pct}%</div><button class="btn-launch" onclick="restartQuiz()">ì²˜ìŒë¶€í„° ë‹¤ì‹œ</button></div>`; return; }
  const q=qs[quizIdx]; quizAnswered=false;
  body.innerHTML=`<div class="quiz-header"><div class="quiz-progress">ë¬¸ì œ ${quizIdx+1} / ${qs.length}</div><div class="quiz-score-badge">ì ìˆ˜ ${quizScore}ì </div></div><div class="timer-track"><div class="timer-bar" id="timerBar" style="width:100%"></div></div><div class="quiz-q">${q.q}</div><div class="quiz-opts">${q.opts.map((o,i)=>`<div class="q-opt" id="qo${i}" onclick="answerQuiz(${i})"><div class="q-opt-key">${'ABCD'[i]}</div>${o}</div>`).join('')}</div>`;
  updateCount('cnt-quiz',quizIdx+1);
  const bar=document.getElementById('timerBar');
  if(bar){bar.style.transition='width 15s linear';setTimeout(()=>bar.style.width='0%',50);setTimeout(()=>{if(!quizAnswered){document.querySelectorAll('.q-opt').forEach(b=>b.style.pointerEvents='none');const c=document.getElementById('qo'+q.correct);if(c)c.classList.add('correct');quizAnswered=true;setTimeout(()=>{quizIdx++;renderQuiz();},1800);}},15000);}
}

function answerQuiz(idx) {
  if(quizAnswered) return; quizAnswered=true;
  const q=(quizzes[ctx]||quizzes.edu)[quizIdx];
  document.querySelectorAll('.q-opt').forEach(b=>b.style.pointerEvents='none');
  if(idx===q.correct){document.getElementById('qo'+idx).classList.add('correct');quizScore++;totalResponses++;updateStats();addFeed('í€´ì¦ˆ ì •ë‹µ! ğŸ‰','#22a05a');}
  else{document.getElementById('qo'+idx).classList.add('wrong');const c=document.getElementById('qo'+q.correct);if(c)c.classList.add('correct');addFeed('í€´ì¦ˆ ì˜¤ë‹µ ğŸ˜…','#e05050');}
  setTimeout(()=>{quizIdx++;renderQuiz();},1800);
}

function restartQuiz(){quizIdx=0;quizScore=0;quizAnswered=false;renderQuiz();}

// ============================================================
//   RATING
// ============================================================
let currentRating=0;
const ratingLabels=['','í˜•í¸ì—†ì–´ìš” ğŸ˜','ì•„ì‰¬ì›Œìš” ğŸ˜•','ë³´í†µì´ì—ìš” ğŸ˜','ì¢‹ì•„ìš” ğŸ˜Š','ë§¤ìš° ì¢‹ì•„ìš” ğŸŒŸ'];
function hoverStar(n){updateStarDisplay(n);document.getElementById('ratingLabel').textContent=ratingLabels[n];}
function unhoverStar(){updateStarDisplay(currentRating);document.getElementById('ratingLabel').textContent=currentRating?ratingLabels[currentRating]:'ë³„ì ì„ í´ë¦­í•´ í‰ê°€ì— ì°¸ì—¬í•˜ì„¸ìš”';}
function updateStarDisplay(n){document.querySelectorAll('.star').forEach((s,i)=>{s.classList.toggle('active',i<n);s.style.color=i<n?'var(--theme-a)':'';}); }

async function rate(n) {
  currentRating=n; updateStarDisplay(n); document.getElementById('ratingLabel').textContent=ratingLabels[n];
  const newR=[...ratings,n]; const wrote=await fbSet('rating',newR);
  if(!wrote){ratings.push(n);totalResponses++;updateStats();updateRatingResult();updateCount('cnt-rating',ratings.length);}
  addFeed(`ë§Œì¡±ë„ ${n}ì  í‰ê°€ ì œì¶œë¨`,'var(--theme-a)');
}

function updateRatingResult() {
  if(!ratings.length) return;
  const avg=(ratings.reduce((a,b)=>a+b,0)/ratings.length).toFixed(1);
  document.getElementById('ratingAvg').textContent=avg;
  document.getElementById('ratingResult').style.display='flex';
  const dist=document.getElementById('ratingDistribution'); dist.innerHTML='';
  for(let s=5;s>=1;s--){const cnt=ratings.filter(r=>r===s).length;const pct=Math.round(cnt/ratings.length*100);dist.innerHTML+=`<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px"><span style="font-size:11px;width:12px;color:var(--theme-a);font-weight:700">${s}</span><div style="width:80px;height:6px;background:var(--off2);border-radius:3px;overflow:hidden"><div style="width:${pct}%;height:100%;background:var(--theme-g);border-radius:3px;transition:width 0.5s"></div></div><span style="font-size:10px;color:var(--muted)">${cnt}</span></div>`;}
  document.getElementById('ratingAvg').style.color='var(--theme-a)';
}

async function resetRating(){await fbSet('rating',[]);ratings=[];currentRating=0;updateStarDisplay(0);document.getElementById('ratingResult').style.display='none';document.getElementById('ratingLabel').textContent='ë³„ì ì„ í´ë¦­í•´ í‰ê°€ì— ì°¸ì—¬í•˜ì„¸ìš”';updateCount('cnt-rating',0);}
async function addRandomRatings(){const n=Math.floor(Math.random()*10)+5;const nr=[...ratings,...Array.from({length:n},()=>Math.floor(Math.random()*2)+4)];await fbSet('rating',nr);if(!FIREBASE_READY){ratings=nr;totalResponses+=n;updateStats();updateRatingResult();updateCount('cnt-rating',ratings.length);}addFeed(`${n}ê°œ í…ŒìŠ¤íŠ¸ í‰ê°€ ì¶”ê°€ë¨`,'var(--muted)');}

// ============================================================
//   SLIDER
// ============================================================
function updateSlider(){document.getElementById('sliderVal').textContent=document.getElementById('mySlider').value;}

async function submitSlider(){const v=parseInt(document.getElementById('mySlider').value);const nr=[...sliderResponses,v];const wrote=await fbSet('slider',nr);if(!wrote){sliderResponses.push(v);totalResponses++;updateStats();renderSliderResults();updateCount('cnt-slider',sliderResponses.length);}addFeed(`ìŠ¬ë¼ì´ë” ì‘ë‹µ: ${v}ì `,'var(--theme-a)');}

function renderSliderResults(){const c=document.getElementById('sliderResultBars');if(!c||!sliderResponses.length){if(c)c.innerHTML='';return;}const avg=Math.round(sliderResponses.reduce((a,b)=>a+b,0)/sliderResponses.length);const buckets=[0,25,50,75,100];const labels=['0-25','26-50','51-75','76-100'];const counts=labels.map((_,i)=>sliderResponses.filter(v=>v>=buckets[i]&&v<=buckets[i+1]).length);const max=Math.max(...counts)||1;c.innerHTML=`<div style="font-size:12px;color:var(--muted);margin-bottom:10px">í‰ê· : <strong style="color:var(--theme-a);font-size:18px">${avg}</strong> / 100 Â· ${sliderResponses.length}ëª… ì‘ë‹µ</div>${labels.map((l,i)=>`<div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:3px"><span>${l}</span><span>${counts[i]}ëª…</span></div><div class="slider-result-bar"><div class="slider-result-fill" style="width:${Math.round(counts[i]/max*100)}%"></div></div></div>`).join('')}`;}

async function addRandomSliders(){const n=Math.floor(Math.random()*12)+5;const nr=[...sliderResponses,...Array.from({length:n},()=>Math.floor(Math.random()*101))];await fbSet('slider',nr);if(!FIREBASE_READY){sliderResponses=nr;totalResponses+=n;updateStats();renderSliderResults();updateCount('cnt-slider',sliderResponses.length);}addFeed(`${n}ê°œ í…ŒìŠ¤íŠ¸ ìŠ¬ë¼ì´ë” ì‘ë‹µ ì¶”ê°€ë¨`,'var(--muted)');}
async function resetSlider(){await fbSet('slider',[]);sliderResponses=[];renderSliderResults();updateCount('cnt-slider',0);}

// ============================================================
//   QR CODE GENERATOR (ìˆœìˆ˜ JS, ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ìŒ)
// ============================================================
// QR ìƒì„± - actively1.netlify.app ê³ ì • URL + ì„¸ì…˜ ì½”ë“œ
function drawQR(url) {
  const canvas = document.getElementById('qrCanvas');
  if (!canvas) return;
  const ctx2 = canvas.getContext('2d');
  const size = 150;
  canvas.width = size; canvas.height = size;

  // QR ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì´ ê°„ë‹¨í•œ ë§¤íŠ¸ë¦­ìŠ¤ ë°©ì‹ìœ¼ë¡œ ìƒì„±
  // qrcodejs CDN ë™ì  ë¡œë“œ
  if (!window._qrLoaded) {
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
    s.onload = () => { window._qrLoaded = true; renderQRWithLib(url); };
    document.head.appendChild(s);
  } else {
    renderQRWithLib(url);
  }
}

function renderQRWithLib(url) {
  const canvas = document.getElementById('qrCanvas');
  if (!canvas || !window.QRCode) return;
  // QRCode ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ì„ì‹œ divì— ìƒì„± í›„ canvasì— ê·¸ë¦¬ê¸°
  const tmp = document.createElement('div');
  tmp.style.display = 'none';
  document.body.appendChild(tmp);
  new QRCode(tmp, {
    text: url, width: 150, height: 150,
    colorDark: '#1a1916', colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.M
  });
  setTimeout(() => {
    const img = tmp.querySelector('img');
    const ctx2 = canvas.getContext('2d');
    if (img) {
      const i = new Image();
      i.onload = () => { ctx2.drawImage(i, 0, 0, 150, 150); };
      i.src = img.src;
    }
    document.body.removeChild(tmp);
  }, 100);
}

// ============================================================
//   PARTICIPANT VIEW â€” ë‹‰ë„¤ì„ & ì œì¶œ ë²„íŠ¼
// ============================================================
let participantNickname = '';

function confirmNickname() {
  const input = document.getElementById('nicknameInput');
  participantNickname = input ? input.value.trim() : '';
  if (!participantNickname) participantNickname = 'ìµëª…';

  // ë°°ì§€ í‘œì‹œ
  const badge = document.getElementById('pNicknameBadge');
  if (badge) { badge.textContent = 'ğŸ‘¤ ' + participantNickname; badge.style.display = 'block'; }

  // ì˜¤ë²„ë ˆì´ ë‹«ê¸°
  const overlay = document.getElementById('nicknameOverlay');
  if (overlay) overlay.style.display = 'none';

  addFeed(`${participantNickname} ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤`, '#22a05a');
  if (db && roomCode) {
    db.ref(`sessions/${roomCode}/participants`).transaction(n => (n || 0) + 1);
  }
}

function submitBtn(label, onclick) {
  return `<button onclick="${onclick}" style="width:100%;padding:14px;border-radius:12px;border:none;background:var(--theme-g);color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:var(--font);margin-top:14px;box-shadow:0 4px 14px rgba(0,0,0,0.12);">${label}</button>`;
}

function showSubmitSuccess(msg) {
  document.getElementById('pContent').innerHTML = `
    <div style="text-align:center;padding:32px 20px;">
      <div style="font-size:48px;margin-bottom:12px;">âœ…</div>
      <div style="font-size:18px;font-weight:700;color:var(--theme-a);margin-bottom:6px;">${msg}</div>
      <div style="font-size:13px;color:var(--muted);">ì‘ë‹µì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œëì–´ìš”</div>
    </div>`;
}

function updateParticipantView(act) {
  const pTitle = document.getElementById('pTitle');
  const pContent = document.getElementById('pContent');
  if (!pTitle || !pContent) return;

  if (act === 'poll') {
    // pollì€ Firebase ë¦¬ìŠ¤ë„ˆê°€ ë”°ë¡œ ì²˜ë¦¬
  } else if (act === 'wordcloud') {
    pTitle.textContent = 'ì›Œë“œí´ë¼ìš°ë“œ â€” ë‹¨ì–´ ì…ë ¥';
    pContent.innerHTML = `
      <div style="margin-bottom:8px;font-size:13px;color:var(--muted);">ë– ì˜¤ë¥´ëŠ” ë‹¨ì–´ë¥¼ ììœ ë¡­ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”</div>
      <input type="text" class="form-input" id="pWcInput" placeholder="ë‹¨ì–´ ì…ë ¥..." style="margin-bottom:0;" onkeypress="if(event.key==='Enter') submitParticipantWord()">
      ${submitBtn('ë‹¨ì–´ ì œì¶œí•˜ê¸°', 'submitParticipantWord()')}`;
  } else if (act === 'qa') {
    pTitle.textContent = 'Q&A â€” ìµëª… ì§ˆë¬¸';
    pContent.innerHTML = `
      <div style="margin-bottom:8px;font-size:13px;color:var(--muted);">ê¶ê¸ˆí•œ ì ì„ ììœ ë¡­ê²Œ ì§ˆë¬¸í•˜ì„¸ìš”. ìµëª…ìœ¼ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.</div>
      <textarea class="form-input form-textarea" id="pQaInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." style="min-height:120px;"></textarea>
      ${submitBtn('ì§ˆë¬¸ ì œì¶œí•˜ê¸°', 'submitParticipantQA()')}`;
  } else if (act === 'rating') {
    pTitle.textContent = 'ë§Œì¡±ë„ í‰ê°€';
    pContent.innerHTML = `
      <div style="margin-bottom:16px;font-size:13px;color:var(--muted);text-align:center;">ë³„ì ì„ ì„ íƒí•´ ì£¼ì„¸ìš”</div>
      <div class="rating-stars" style="justify-content:center;font-size:44px;gap:8px;" id="pRatingStars">
        ${[1,2,3,4,5].map(n=>`<span class="star" style="cursor:pointer;" onclick="pSelectStar(${n})" onmouseover="pHoverStar(${n})" onmouseout="pUnhover()">â˜…</span>`).join('')}
      </div>
      <div style="text-align:center;font-size:14px;color:var(--muted);margin-top:8px;min-height:22px;" id="pRatingLabel">ë³„ì ì„ ì„ íƒí•´ ì£¼ì„¸ìš”</div>
      <div id="pRatingSubmitArea"></div>`;
  } else if (act === 'slider') {
    pTitle.textContent = 'ìŠ¬ë¼ì´ë” ì‘ë‹µ';
    const minLbl = document.getElementById('sliderMinLbl')?.textContent || 'ë‚®ìŒ';
    const maxLbl = document.getElementById('sliderMaxLbl')?.textContent || 'ë†’ìŒ';
    pContent.innerHTML = `
      <div style="margin-bottom:20px;font-size:13px;color:var(--muted);text-align:center;">ìŠ¬ë¼ì´ë”ë¥¼ ì›€ì§ì—¬ ì˜ê²¬ì„ í‘œí˜„í•´ ì£¼ì„¸ìš”</div>
      <input type="range" min="0" max="100" value="50" id="pSlider" style="width:100%;accent-color:var(--theme-a);" oninput="document.getElementById('pSliderVal').textContent=this.value">
      <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:6px;">
        <span>${minLbl}</span><span id="pSliderVal" style="font-weight:700;color:var(--theme-a);">50</span><span>${maxLbl}</span>
      </div>
      ${submitBtn('ì œì¶œí•˜ê¸°', 'submitParticipantSlider()')}`;
  } else {
    pTitle.textContent = 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”';
    pContent.innerHTML = `<div style="text-align:center;padding:32px;color:var(--muted);font-size:14px;">ë°œí‘œìê°€ í™œë™ì„ ì‹œì‘í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>`;
  }
}

// ë³„ì  ì„ íƒ
let pSelectedRating = 0;
const ratingEmoji = ['', 'ğŸ˜', 'ğŸ˜•', 'ğŸ˜', 'ğŸ˜Š', 'ğŸŒŸ'];
const ratingWord = ['', 'í˜•í¸ì—†ì–´ìš”', 'ì•„ì‰¬ì›Œìš”', 'ë³´í†µì´ì—ìš”', 'ì¢‹ì•„ìš”', 'ë§¤ìš° ì¢‹ì•„ìš”'];

function pSelectStar(n) {
  pSelectedRating = n;
  updatePStars(n);
  document.getElementById('pRatingLabel').textContent = ratingEmoji[n] + ' ' + ratingWord[n];
  document.getElementById('pRatingSubmitArea').innerHTML = submitBtn('í‰ê°€ ì œì¶œí•˜ê¸°', 'submitParticipantRating()');
}
function pHoverStar(n) { updatePStars(n); document.getElementById('pRatingLabel').textContent = ratingEmoji[n] + ' ' + ratingWord[n]; }
function pUnhover() { updatePStars(pSelectedRating); document.getElementById('pRatingLabel').textContent = pSelectedRating ? ratingEmoji[pSelectedRating] + ' ' + ratingWord[pSelectedRating] : 'ë³„ì ì„ ì„ íƒí•´ ì£¼ì„¸ìš”'; }
function updatePStars(n) {
  document.querySelectorAll('#pRatingStars .star').forEach((s, i) => { s.style.color = i < n ? 'var(--theme-a)' : 'var(--border2)'; });
}

// ì œì¶œ í•¨ìˆ˜ë“¤
async function submitParticipantWord() {
  const input = document.getElementById('pWcInput');
  const w = input?.value.trim().toLowerCase().replace(/\s+/g, '_');
  if (!w) return;
  if (db && roomCode) await db.ref(`sessions/${roomCode}/wordcloud/${w}`).transaction(n => (n || 0) + 1);
  showSubmitSuccess(`"${w.replace(/_/g,' ')}" ë“±ë¡ ì™„ë£Œ!`);
}

async function submitParticipantQA() {
  const input = document.getElementById('pQaInput');
  const q = input?.value.trim();
  if (!q) return;
  const author = participantNickname || 'ìµëª…';
  if (db && roomCode) {
    await db.ref(`sessions/${roomCode}/qa`).push({ q, author, votes: 0, answered: false, timestamp: Date.now() });
  }
  showSubmitSuccess('ì§ˆë¬¸ì´ ë“±ë¡ëì–´ìš”!');
}

async function submitParticipantRating() {
  if (!pSelectedRating) return;
  if (db && roomCode) {
    const snap = await db.ref(`sessions/${roomCode}/rating`).once('value');
    await db.ref(`sessions/${roomCode}/rating`).set([...(snap.val() || []), pSelectedRating]);
  }
  showSubmitSuccess(`${ratingEmoji[pSelectedRating]} ${pSelectedRating}ì ìœ¼ë¡œ í‰ê°€ ì™„ë£Œ!`);
}

async function submitParticipantSlider() {
  const v = parseInt(document.getElementById('pSlider')?.value || 50);
  if (db && roomCode) {
    const snap = await db.ref(`sessions/${roomCode}/slider`).once('value');
    await db.ref(`sessions/${roomCode}/slider`).set([...(snap.val() || []), v]);
  }
  showSubmitSuccess(`${v}ì ìœ¼ë¡œ ì‘ë‹µ ì™„ë£Œ!`);
}

async function participantVote(code, optIdx, optName) {
  if (!db) return;
  await db.ref(`sessions/${code}/poll/votes/${optIdx}`).transaction(n => (n || 0) + 1);
  await db.ref(`sessions/${code}/responses`).transaction(n => (n || 0) + 1);
  // íˆ¬í‘œ ë²„íŠ¼ ë¹„í™œì„±í™” + ì™„ë£Œ ë©”ì‹œì§€
  document.querySelectorAll('#pContent .v-btn').forEach(b => { b.disabled = true; b.style.opacity = '0.4'; });
  showSubmitSuccess(`"${optName}" ì— íˆ¬í‘œ ì™„ë£Œ!`);
}

function previewParticipant() {
  document.getElementById('pContextLabel').textContent = ctxConfig[ctx].label;
  // ë‹‰ë„¤ì„ ì˜¤ë²„ë ˆì´ ë‹¤ì‹œ í‘œì‹œ (ë¯¸ë¦¬ë³´ê¸°ì´ë¯€ë¡œ ìŠ¤í‚µ)
  const overlay = document.getElementById('nicknameOverlay');
  if (overlay) overlay.style.display = 'none';
  const badge = document.getElementById('pNicknameBadge');
  if (badge) { badge.textContent = 'ğŸ‘¤ ë¯¸ë¦¬ë³´ê¸°'; badge.style.display = 'block'; }

  const active = document.querySelector('.activity-panel.active');
  const actId = active ? active.id.replace('ap-', '') : 'poll';
  updateParticipantView(actId);

  if (actId === 'poll') {
    const q = pollLive ? pollData.q : (document.getElementById('pollQ')?.value || 'íˆ¬í‘œ ì§ˆë¬¸');
    const opts = pollLive ? pollData.opts : Array.from(document.querySelectorAll('#pollOpts input')).map(i => i.value);
    document.getElementById('pTitle').textContent = q;
    document.getElementById('pContent').innerHTML =
      opts.map((o, i) => `<button class="v-btn" style="width:100%;margin-bottom:10px;padding:14px;font-size:14px;" onclick="participantVote('${roomCode}',${i},'${o}')">${o}</button>`).join('') +
      `<div style="font-size:12px;color:var(--muted);text-align:center;margin-top:4px;">í•˜ë‚˜ë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ì œì¶œë©ë‹ˆë‹¤</div>`;
  }
  showScreen('participant');
}

function closeParticipant() { showScreen('host'); }

// ============================================================
//   MISC â€” copyJoinLink (QRë„ í•¨ê»˜ ì—…ë°ì´íŠ¸)
// ============================================================
function copyJoinLink() {
  const joinUrl = 'https://actively1.netlify.app' + (roomCode ? `?join=${roomCode}` : '');
  navigator.clipboard?.writeText(joinUrl).catch(() => {});

  // ë§í¬ í‘œì‹œ ë°•ìŠ¤ ì—…ë°ì´íŠ¸
  const display = document.getElementById('joinLinkDisplay');
  if (display) display.textContent = joinUrl;

  // QR ì¬ìƒì„±
  drawQR(joinUrl);

  // ë²„íŠ¼ í”¼ë“œë°±
  const btn = document.getElementById('copyLinkBtn');
  if (btn) { btn.textContent = 'âœ“ ë³µì‚¬ë¨!'; setTimeout(() => btn.textContent = 'ğŸ”— ë§í¬ ë³µì‚¬', 2000); }
  const navBtn = document.querySelector('.btn-primary-theme[onclick="copyJoinLink()"]');
  if (navBtn) { navBtn.textContent = 'âœ“ ë³µì‚¬ë¨!'; setTimeout(() => navBtn.textContent = 'ğŸ”— ë§í¬ ë³µì‚¬', 2000); }

  addFeed('ì°¸ì—¬ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'var(--muted)');
}

// ============================================================
//   UI MODE SWITCHER
// ============================================================
function setUiMode(mode){currentUiMode=mode;document.body.classList.remove('ui-dark','ui-vivid');if(mode==='dark')document.body.classList.add('ui-dark');if(mode==='vivid')document.body.classList.add('ui-vivid');['light','dark','vivid'].forEach(m=>{const s1=document.getElementById('sw-'+m);const s2=document.getElementById('land-sw-'+m);if(s1)s1.classList.toggle('active',m===mode);if(s2)s2.classList.toggle('active',m===mode);});if(ctx)setTheme(ctx);}

// ============================================================
//   INIT â€” Auto-join via URL param
// ============================================================
(function init(){
  const params = new URLSearchParams(location.search);
  const joinCode = params.get('join');
  if (joinCode && FIREBASE_READY) {
    // URLë¡œ ì§ì ‘ ì ‘ì†í•œ ì°¸ì—¬ì â†’ ë‹‰ë„¤ì„ í™”ë©´ ë¨¼ì € ë³´ì—¬ì£¼ê³  ì…ì¥
    showScreen('participant');
    const overlay = document.getElementById('nicknameOverlay');
    if (overlay) overlay.style.display = 'flex';
    // confirmNickname í›„ ì‹¤ì œ ì„¸ì…˜ ì—°ê²°
    window._pendingJoinCode = joinCode;
    const origConfirm = window.confirmNickname;
    window.confirmNickname = async function() {
      origConfirm();
      // joinCodeInputì´ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì½”ë“œë¥¼ ì§ì ‘ joinSessionFirebaseì— ì „ë‹¬
      const btn = document.querySelector('.btn-join');
      const ok = await joinSessionFirebase(joinCode);
      if (ok) {
        setTheme(ctx);
        const ctxLbl = document.getElementById('pContextLabel');
        if (ctxLbl) ctxLbl.textContent = ctxConfig[ctx]?.label || 'ì„¸ì…˜';
        attachKickListener();
        showQAFab(true);
      } else {
        alert('ì„¸ì…˜ ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. ë§í¬ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.');;
        showScreen('landing');
      }
    };
  } else {
    showScreen('landing');
  }
  if (!FIREBASE_READY) {
    setTimeout(() => { document.getElementById('firebase-banner').style.display = 'flex'; }, 1500);
    setFbStatus('demo');
  }
})();


/* ============================================================
   Admin Restore (Link key-based, works in incognito/other PC)
============================================================ */

/** Show a copy-friendly dialog for admin link */
function showAdminLink(adminLink){
  try{
    // Best UX: try clipboard, fallback to prompt
    if(typeof copyText === 'function') copyText(adminLink);
  }catch(e){}
  // prompt allows easy copy on PC
  window.prompt("ğŸ” ê´€ë¦¬ì ë§í¬ (ë³µì‚¬í•´ì„œ ë³¸ì¸ë§Œ ë³´ê´€í•˜ì„¸ìš”)", adminLink);
}

/**
 * Restore host mode from URL (?host=CODE&key=HOSTKEY)
 * - No PIN (PIN couldn't be verified across reloads)
 * - Verifies key against Firebase sessions/{code}/hostKey
 */
async function restoreHostFromLink(hostCode, key){
  if(!hostCode || !key) return;

  if(!FIREBASE_READY){
    alert("Firebase ì—°ê²°ì´ í•„ìš”í•´ìš”. (í˜¸ìŠ¤íŠ¸ ë³µêµ¬ëŠ” Firebase ì—°ê²° ìƒíƒœì—ì„œë§Œ ê°€ëŠ¥)");
    return;
  }

  try{
    // Show a lightweight blocking overlay while restoring
    const ov = document.getElementById("adminPinOverlay");
    if(ov){
      ov.style.display = "flex";
      ov.querySelector("h3").textContent = "ê´€ë¦¬ì ë³µêµ¬ ì¤‘â€¦";
      ov.querySelector("#adminPinInput").style.display = "none";
      ov.querySelector("button").style.display = "none";
      const box = ov.querySelector("div");
      const msgId = "adminRestoreMsg";
      let msg = document.getElementById(msgId);
      if(!msg){
        msg = document.createElement("div");
        msg.id = msgId;
        msg.style.marginTop = "10px";
        msg.style.color = "#333";
        msg.style.fontWeight = "800";
        box.appendChild(msg);
      }
      msg.textContent = "ì„¸ì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦";
    }

    const snap = await db.ref(`sessions/${hostCode}`).once('value');
    if(!snap.exists()){
      if(ov) ov.style.display = "none";
      alert("í•´ë‹¹ ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. (ì„¸ì…˜ ì½”ë“œ í™•ì¸ í•„ìš”)");
      return;
    }
    const s = snap.val() || {};
    if((s.hostKey || "") !== key){
      if(ov) ov.style.display = "none";
      alert("ê´€ë¦¬ì í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”. ë§í¬ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.");
      return;
    }

    // Set core globals
    roomCode = hostCode;
    hostKey = key;
    isHost = true;
    ctx = s.ctx || ctx || 'edu';
    sessionTitle = s.title || sessionTitle || '';

    // Apply theme + move to host screen
    setTheme(ctx);
    showScreen('host');

    // Update top/title UI immediately
    try{ setTopTitle(sessionTitle || ''); }catch(e){}
    const rc = document.getElementById("navRoomCode");
    if(rc) rc.textContent = roomCode;

    // Update join link + QR
    const joinUrl = `${location.origin}${location.pathname}?join=${roomCode}`;
    const linkEl = document.getElementById("joinLinkDisplay");
    if(linkEl) linkEl.textContent = joinUrl;
    setTimeout(()=>{ try{ drawQR(joinUrl); }catch(e){} }, 150);

    // Hydrate local states from snapshot (best-effort)
    totalParticipants = Number(s.participants || 0);
    totalResponses = Number(s.responses || 0);

    // Poll
    if(s.poll){
      pollLive = !!s.poll.live;
      pollData.q = s.poll.q || '';
      pollData.opts = Array.isArray(s.poll.opts) ? s.poll.opts : [];
      pollData.votes = pollData.opts.map((_,i)=> Number((s.poll.votes||{})[i] || 0));
      renderPollBars();
    }

    // Wordcloud
    if(s.wordcloud){
      wcData = s.wordcloud || {};
      renderWC();
    }

    // Rating
    if(s.rating){
      ratings = Array.isArray(s.rating) ? s.rating : [];
      updateRatingResult();
    }

    // Slider
    if(s.slider){
      sliderResponses = Array.isArray(s.slider) ? s.slider : [];
      renderSliderResults();
    }

    // QA
    if(s.qa){
      // Convert map -> array
      qaItems = Object.entries(s.qa).map(([id,v])=>({id, ...(v||{})}));
      totalQuestions = qaItems.length;
      renderQA();
      try{ updateQAFilterCounts(); }catch(e){}
    }else{
      totalQuestions = 0;
      qaItems = [];
      renderQA();
      try{ updateQAFilterCounts(); }catch(e){}
    }

    updateStats();

    // Keep title synced (host)
    try{
      db.ref(`sessions/${roomCode}/title`).on('value', snap2=>{
        const t = snap2.val() || '';
        sessionTitle = t;
        try{ setTopTitle(t); }catch(e){}
      });
    }catch(e){}

    // Attach realtime listeners WITHOUT resetting the session (do not call initHostSession)
    try{ attachHostRealtimeListeners(); }catch(e){ console.warn(e); }

    // Clear overlay
    if(ov) ov.style.display = "none";

  }catch(err){
    const ov = document.getElementById("adminPinOverlay");
    if(ov) ov.style.display = "none";
    alert("ê´€ë¦¬ì ë³µêµ¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: " + (err && err.message ? err.message : err));
  }
}

/** Attach host listeners only (no db.set that can wipe session) */
function attachHostRealtimeListeners(){
  if(!FIREBASE_READY || !db || !roomCode) return;

  // Basic meta
  fbOffAll();
  // Connection
  db.ref('.info/connected').on('value', s => {
    if(s.val()) { setFbStatus('connected'); addFeed('âœ… Firebase ì—°ê²°ë¨'); }
    else { setFbStatus('demo'); addFeed('âš ï¸ Firebase ì—°ê²° ëŠê¹€'); }
  });

  // Counters + meta
  fbOn('participants', 'value', snap => { totalParticipants = Number(snap.val() || 0); updateStats(); });
  fbOn('responses', 'value', snap => { totalResponses = Number(snap.val() || 0); updateStats(); });

  // Active activity
  fbOn('activeActivity','value', snap => {
    const act = snap.val();
    if(act && act !== activeActivity){
      switchActivity(act, null);
    }
  });

  // Poll
  fbOn('poll','value', snap => {
    const p = snap.val() || {};
    pollLive = !!p.live;
    pollData.q = p.q || '';
    pollData.opts = Array.isArray(p.opts) ? p.opts : [];
    pollData.votes = pollData.opts.map((_,i)=> Number((p.votes||{})[i] || 0));
    renderPollBars();
  });

  // Wordcloud
  fbOn('wordcloud','value', snap => {
    wcData = snap.val() || {};
    renderWC();
  });

  // Rating
  fbOn('rating','value', snap => {
    const r = snap.val();
    ratings = Array.isArray(r) ? r : [];
    updateRatingResult();
  });

  // Slider
  fbOn('slider','value', snap => {
    const v = snap.val();
    sliderResponses = Array.isArray(v) ? v : [];
    renderSliderResults();
  });

  // QA
  fbOn('qa','child_added', snap => {
    const v = snap.val();
    if(!v) return;
    qaItems.unshift({ id: snap.key, ...v });
    totalQuestions = qaItems.length;
    renderQA();
    try{ updateQAFilterCounts(); }catch(e){}
    updateStats();
  });
  fbOn('qa','child_changed', snap => {
    const v = snap.val();
    const idx = qaItems.findIndex(x=>x.id===snap.key);
    if(idx>=0) qaItems[idx] = { id: snap.key, ...(v||{}) };
    renderQA();
    try{ updateQAFilterCounts(); }catch(e){}
  });

  addFeed('ğŸ” ê´€ë¦¬ì ë³µêµ¬: ì‹¤ì‹œê°„ ë™ê¸°í™” ì—°ê²°ë¨');
}

// Hook: after session start, show admin link (copy-friendly)
if(typeof startAsHost === "function"){
  const _origStart = startAsHost;
  startAsHost = async function(...args){
    await _origStart.apply(this,args);

    // Save hostKey locally (optional convenience)
    try{ localStorage.setItem("actively_hostkey_"+roomCode, hostKey); }catch(e){}

    const adminLink = `${location.origin}${location.pathname}?host=${roomCode}&key=${hostKey}`;
    showAdminLink(adminLink);
  }
}

// Auto restore host from URL (incognito/other device OK)
(function(){
  const params = new URLSearchParams(location.search);
  const hostCode = params.get("host");
  const key = params.get("key");
  if(hostCode && key){
    // defer until Firebase init completes
    window.addEventListener('load', ()=> restoreHostFromLink(hostCode, key));
  }
})();

/* ============================================================
   Archive + Template Save/Load (Host only, full snapshot)
============================================================ */
let savedKind = 'archives';

function fmtTime(ts){
  try{
    const d = new Date(ts);
    return d.toLocaleString(undefined, {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
  }catch(e){ return ''; }
}

function openSavedOverlay(kind){
  if(!isHost){ alert('ê´€ë¦¬ì(ë°œí‘œì)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.'); return; }
  if(!FIREBASE_READY){ alert('Firebase ì—°ê²°ì´ í•„ìš”í•´ìš”.'); return; }
  savedKind = kind || 'archives';
  const t = document.getElementById('savedTitle');
  if(t) t.textContent = savedKind === 'archives' ? 'ğŸ“š ì €ì¥ëœ ì„¸ì…˜' : 'ğŸ§© ì €ì¥ëœ í…œí”Œë¦¿';
  const ov = document.getElementById('savedOverlay');
  if(ov){ ov.style.display = 'flex'; }
  refreshSavedList();
}

function closeSavedOverlay(){
  const ov = document.getElementById('savedOverlay');
  if(ov) ov.style.display = 'none';
}

async function saveCurrentAs(kind){
  if(!isHost){ alert('ê´€ë¦¬ì(ë°œí‘œì)ë§Œ ì €ì¥í•  ìˆ˜ ìˆì–´ìš”.'); return; }
  if(!FIREBASE_READY){ alert('Firebase ì—°ê²°ì´ í•„ìš”í•´ìš”.'); return; }
  if(!roomCode){ alert('ì„¸ì…˜ ì½”ë“œê°€ ì—†ì–´ìš”. ë¨¼ì € ì„¸ì…˜ì„ ì‹œì‘í•´ ì£¼ì„¸ìš”.'); return; }
  kind = kind || 'archives';
  savedKind = kind;

  try{
    const snap = await db.ref(`sessions/${roomCode}`).once('value');
    const data = snap.val();
    if(!data){ alert('ì €ì¥í•  ì„¸ì…˜ ë°ì´í„°ê°€ ì—†ì–´ìš”.'); return; }

    const id = Date.now().toString(36);
    const payload = {
      ...data,
      savedAt: Date.now(),
      sourceRoom: roomCode,
      savedType: (kind === 'archives') ? 'archive' : 'template'
    };

    if(!hostKey){ alert('hostKeyê°€ ì—†ì–´ìš”. ê´€ë¦¬ì ì„¸ì…˜ì„ ë‹¤ì‹œ ì‹œì‘í•´ ì£¼ì„¸ìš”.'); return; }
    await db.ref(`${kind}/${hostKey}/${id}`).set(payload);
    addFeed((kind==='archives'?'ì„¸ì…˜':'í…œí”Œë¦¿')+' ì €ì¥ ì™„ë£Œ', 'var(--theme-g)');
    alert((kind==='archives'?'ì„¸ì…˜':'í…œí”Œë¦¿')+'ì´ ì €ì¥ëì–´ìš”!');
    const ov = document.getElementById('savedOverlay');
    if(ov && ov.style.display !== 'none') refreshSavedList();
  }catch(e){
    console.error('saveCurrentAs error:', e);
    const msg = e?.message || String(e);
    if(msg.includes('PERMISSION_DENIED')){
      alert('ì €ì¥ ê¶Œí•œì´ ì—†ì–´ìš” (PERMISSION_DENIED).\n\nFirebase ì½˜ì†” â†’ Realtime Database â†’ Rulesì—ì„œ\nìµœìƒìœ„ì— ".write": true ê°€ ì ìš©ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.\n\ní˜„ì¬ ê²½ë¡œ: ' + kind + '/' + hostKey);
    } else {
      alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.\n\n' + msg);
    }
  }
}

async function refreshSavedList(){
  if(!FIREBASE_READY) return;
  const list = document.getElementById('savedList');
  if(!list) return;
  list.innerHTML = `<div style="padding:12px;color:var(--muted);font-weight:700;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>`;

  try{
    if(!hostKey){ list.innerHTML = `<div style="padding:14px;border:1px dashed var(--border);border-radius:16px;color:var(--muted);font-weight:800;">hostKeyê°€ ì—†ì–´ìš”. ê´€ë¦¬ì ì„¸ì…˜ì„ ë‹¤ì‹œ ì‹œì‘í•´ ì£¼ì„¸ìš”.</div>`; return; }
    const snap = await db.ref(`${savedKind}/${hostKey}`).limitToLast(60).once('value');
    const obj = snap.val() || {};
    const items = Object.entries(obj)
      .map(([id,v]) => ({id, ...v}))
      .sort((a,b)=> (b.savedAt||0) - (a.savedAt||0));

    if(items.length===0){
      list.innerHTML = `<div style="padding:14px;border:1px dashed var(--border);border-radius:16px;color:var(--muted);font-weight:800;">ì•„ì§ ì €ì¥ëœ í•­ëª©ì´ ì—†ì–´ìš”.</div>`;
      return;
    }

    list.innerHTML = items.map(it=>{
      const label = (savedKind==='archives') ? 'ì„¸ì…˜' : 'í…œí”Œë¦¿';
      const ctxLabel = (window.ctxConfig && it.ctx && ctxConfig[it.ctx]) ? ctxConfig[it.ctx].label : (it.ctx||'');
      const title = it.title || it.name || (ctxLabel ? `${ctxLabel} ${label}` : `${label}`);
      const when = fmtTime(it.savedAt || it.createdAt || Date.now());
      const src = it.sourceRoom ? `ì›ë³¸: ${it.sourceRoom}` : '';
      const stats = [
        (typeof it.participants==='number') ? `ì°¸ì—¬ ${it.participants}` : '',
        (typeof it.responses==='number') ? `ì‘ë‹µ ${it.responses}` : ''
      ].filter(Boolean).join(' Â· ');

      return `
        <div style="border:1px solid var(--border);border-radius:18px;padding:12px 12px;margin-top:10px;background:var(--surface);display:flex;gap:12px;align-items:center;">
          <div style="flex:1;min-width:0;">
            <div style="font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${title}</div>
            <div style="font-size:12px;color:var(--muted);margin-top:3px;line-height:1.4;">${when}${ctxLabel?` Â· ${ctxLabel}`:''}${src?` Â· ${src}`:''}</div>
            ${stats?`<div style="font-size:12px;color:var(--muted);margin-top:6px;font-weight:800;">${stats}</div>`:''}
          </div>
          <button onclick="loadSavedItem('${it.id}')" style="border:none;background:var(--theme-a);color:#fff;border-radius:14px;padding:10px 12px;font-weight:950;cursor:pointer;white-space:nowrap;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
      `;
    }).join('');
  }catch(e){
    console.error(e);
    list.innerHTML = `<div style="padding:14px;border:1px dashed var(--border);border-radius:16px;color:var(--muted);font-weight:800;">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.</div>`;
  }
}

async function loadSavedItem(id){
  if(!isHost){ alert('ê´€ë¦¬ì(ë°œí‘œì)ë§Œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”.'); return; }
  if(!FIREBASE_READY){ alert('Firebase ì—°ê²°ì´ í•„ìš”í•´ìš”.'); return; }
  if(!id) return;
  if(!hostKey){ alert('hostKeyê°€ ì—†ì–´ìš”. ê´€ë¦¬ì ì„¸ì…˜ì„ ë‹¤ì‹œ ì‹œì‘í•´ ì£¼ì„¸ìš”.'); return; }

  if(!confirm('ë¶ˆëŸ¬ì˜¤ë©´ ìƒˆ ì„¸ì…˜ ì½”ë“œë¡œ ë³µì œë¼ìš”. ì§„í–‰í• ê¹Œìš”?')) return;

  try{
    const snap = await db.ref(`${savedKind}/${hostKey}/${id}`).once('value');
    const data = snap.val();
    if(!data){ alert('ì €ì¥ëœ ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”.'); return; }

    const newCode = genCode();
    const newCtx = data.ctx || ctx || 'edu';
    ctx = newCtx;
    setTheme(ctx);

    const sessionData = {...data};
    sessionData.createdAt = Date.now();
    sessionData.active = true;
    sessionData.hostKey = hostKey;

    await db.ref(`sessions/${newCode}`).set(sessionData);

    roomCode = newCode;

    document.getElementById('navRoomCode').textContent = roomCode;
    document.getElementById('qrCode').textContent = roomCode;
    if(document.getElementById('navCtxPill')) document.getElementById('navCtxPill').textContent = (ctxConfig[ctx]?.label||'ì„¸ì…˜');

    const joinUrl = `${location.origin}${location.pathname}?join=${roomCode}`;
    const linkDisplay = document.getElementById('joinLinkDisplay');
    if(linkDisplay) linkDisplay.textContent = joinUrl.replace(/^https?:\/\//,'');
    setTimeout(()=>drawQR(joinUrl), 250);

    fbOffAll();

    fbOn('participants','value', s=>{ totalParticipants=s.val()||0; updateStats(); });
    fbOn('nicknames','value', s=>{ participantNames = s.val()||{}; renderParticipantNames(); });
    fbOn('responses','value', s=>{ totalResponses=s.val()||0; updateStats(); });

    fbOn('poll','value', s=>{
      const d=s.val(); if(!d) return;
      pollLive=d.live||false;
      if(d.live&&d.opts){ const v=d.votes||{}; pollData={q:d.q,opts:d.opts,votes:d.opts.map((_,i)=>v[i]||0)}; if(document.getElementById('poll-result-card')?.style.display!=='none') renderPollBars(); }
    });

    fbOn('wordcloud','value', s=>{ wcData=s.val()||{}; if(document.getElementById('ap-wordcloud')?.classList.contains('active')){ renderWC(); updateCount('cnt-wc',Object.keys(wcData).length); }});

    fbOn('qa','child_added', s=>{
      const item={...s.val(),id:s.key,voted:false};
      if(!qaItems.find(i=>i.id===s.key)){
        qaItems.push(item);
        totalQuestions=qaItems.length; updateStats(); renderQA();
        addFeed(`ìƒˆ ì§ˆë¬¸: "${(item.q||'').slice(0,28)}..."`, 'var(--theme-a)');
      }
    });

    fbOn('qa','child_changed', s=>{
      const idx=qaItems.findIndex(i=>i.id===s.key);
      if(idx>=0){ qaItems[idx]={...qaItems[idx],...s.val(),id:s.key}; renderQA(); }
    });

    fbOn('rating','value', s=>{ ratings=s.val()||[]; if(document.getElementById('ap-rating')?.classList.contains('active')){ updateRatingResult(); updateCount('cnt-rating',ratings.length); }});
    fbOn('slider','value', s=>{ sliderResponses=s.val()||[]; if(document.getElementById('ap-slider')?.classList.contains('active')){ renderSliderResults(); updateCount('cnt-slider',sliderResponses.length); }});

    db.ref('.info/connected').on('value', s=>setFbStatus(s.val()?'connected':'offline'));
    setFbStatus('connected');

    closeSavedOverlay();
    addFeed('ì €ì¥ëœ í•­ëª©ì„ ìƒˆ ì„¸ì…˜ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ì–´ìš”', 'var(--theme-g)');
    alert(`ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ! ìƒˆ ì„¸ì…˜ ì½”ë“œ: ${roomCode}`);
  }catch(e){
    console.error(e);
    alert('ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.');
  }
}


/* ============================================================
   Landing UX + Unified History (Local + Firebase)
============================================================ */
let selectedCtx = 'edu';

function createNewSession(){
  const inp = document.getElementById('sessionTitleInput');
  const t = (inp?.value || '').trim();
  if(!t){
    alert('ì„¸ì…˜ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    try{ inp?.focus(); }catch(e){}
    return;
  }
  startAsHost(selectedCtx, null, t);
}

let histFilter = 'all';

function selectCtx(c){
  selectedCtx = c || 'edu';
  document.getElementById('chip-edu')?.classList.toggle('active', selectedCtx==='edu');
  document.getElementById('chip-biz')?.classList.toggle('active', selectedCtx==='biz');
  document.getElementById('chip-evt')?.classList.toggle('active', selectedCtx==='evt');
  const map = {edu:'ğŸ“ ê°•ì˜ & êµìœ¡', biz:'ğŸ’¼ íšŒì‚¬ ë°œí‘œ & íšŒì˜', evt:'ğŸ‰ ì´ë²¤íŠ¸ & í–‰ì‚¬'};
  const hint = document.getElementById('ctxHint');
  if(hint) hint.textContent = `ì„ íƒ: ${map[selectedCtx] || map.edu}`;
}

function fmtLocal(ts){
  try{
    const d = new Date(ts);
    return d.toLocaleString(undefined,{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
  }catch(e){ return ''; }
}

function getLocalHistory(){
  try{
    const raw = localStorage.getItem('actively_history') || '[]';
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}

function setLocalHistory(arr){
  try{ localStorage.setItem('actively_history', JSON.stringify(arr||[])); }catch(e){}
}

function upsertLocalHistory(item){
  const arr = getLocalHistory().filter(x=>x && x.code !== item.code);
  arr.unshift(item);
  setLocalHistory(arr.slice(0, 30));
}

function renderLocalHistory(){
  const el = document.getElementById('localHistory');
  if(!el) return;
  const arr = getLocalHistory();
  if(arr.length === 0){
    el.innerHTML = `<div style="padding:12px;border:1px dashed var(--border);border-radius:16px;color:var(--muted);font-weight:900;">ì•„ì§ ë§Œë“  ì„¸ì…˜ì´ ì—†ì–´ìš”. ìƒˆ ì„¸ì…˜ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</div>`;
    return;
  }
  el.innerHTML = arr.map(it=>{
    const ctxLabel = (window.ctxConfig && it.ctx && ctxConfig[it.ctx]) ? ctxConfig[it.ctx].label : (it.ctx||'');
    const title = it.title ? ` Â· ${escapeHtml(it.title)}` : '';
    const fav = it.favorite ? 'â˜… ' : '';
    return `
      <div class="hist-item">
        <div class="hist-meta">
          <div class="hist-code">${fav}${it.code}${ctxLabel?` Â· ${ctxLabel}`:''}${title}</div>
          <div class="hist-time">${fmtLocal(it.createdAt || Date.now())}</div>
        </div>
        <div class="hist-actions">
          <button class="small-btn primary" onclick="openUrl('${it.adminUrl || ''}')">ê´€ë¦¬ì ì—´ê¸°</button>
          <button class="small-btn" onclick="copyText('${it.joinUrl || ''}')">ì°¸ì—¬ ë§í¬ ë³µì‚¬</button>
          <button class="small-btn" onclick="toggleLocalFav('${it.code}')">â˜…</button>
        </div>
      </div>
    `;
  }).join('');
}

function toggleLocalFav(code){
  const arr = getLocalHistory();
  const idx = arr.findIndex(x=>x.code===code);
  if(idx>=0){
    arr[idx].favorite = !arr[idx].favorite;
    setLocalHistory(arr);
    renderLocalHistory();
  }
}

function openUrl(u){
  if(!u){ alert('ë§í¬ê°€ ì—†ì–´ìš”.'); return; }
  window.open(u, '_blank', 'noopener');
}

async function copyText(t){
  try{ await navigator.clipboard.writeText(t); alert('ë³µì‚¬í–ˆì–´ìš”!'); }
  catch(e){ prompt('ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•´ ì£¼ì„¸ìš”:', t); }
}

function escapeHtml(str){
  return String(str||'')
    .replaceAll('&','&amp;').replaceAll('<','&lt;')
    .replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
}

/* ---------------- Firebase history (hostKey based) ---------------- */
function histRef(){ return hostKey ? db.ref(`history/${hostKey}`) : null; }

async function writeFirebaseHistory(record){
  if(!FIREBASE_READY || !hostKey) return;
  const code = record.code;
  if(!code) return;
  const ref = db.ref(`history/${hostKey}/${code}`);
  const existing = (await ref.once('value')).val() || {};
  await ref.update({
    code,
    ctx: record.ctx || existing.ctx || 'edu',
    createdAt: existing.createdAt || record.createdAt || Date.now(),
    lastUsedAt: Date.now(),
    adminUrl: record.adminUrl || existing.adminUrl || '',
    joinUrl: record.joinUrl || existing.joinUrl || '',
    title: record.title ?? existing.title ?? '',
    favorite: record.favorite ?? existing.favorite ?? false
  });
}

async function toggleFirebaseFav(code){
  if(!FIREBASE_READY || !hostKey) return;
  const ref = db.ref(`history/${hostKey}/${code}/favorite`);
  const cur = (await ref.once('value')).val();
  await ref.set(!cur);
  refreshUnifiedHistory();
}

async function renameFirebaseHistory(code){
  if(!FIREBASE_READY || !hostKey) return;
  const ref = db.ref(`history/${hostKey}/${code}/title`);
  const cur = (await ref.once('value')).val() || '';
  const next = prompt('ì„¸ì…˜ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”:', cur);
  if(next === null) return;
  await ref.set(next.trim());
  refreshUnifiedHistory();
  // also update local view for convenience
  const arr = getLocalHistory();
  const idx = arr.findIndex(x=>x.code===code);
  if(idx>=0){ arr[idx].title = next.trim(); setLocalHistory(arr); renderLocalHistory(); }
}

async function deleteFirebaseHistory(code){
  if(!FIREBASE_READY || !hostKey) return;
  if(!confirm('ì´ ì„¸ì…˜ ê¸°ë¡ì„ íˆìŠ¤í† ë¦¬ì—ì„œ ì‚­ì œí• ê¹Œìš”? (ì €ì¥ëœ ì•„ì¹´ì´ë¸Œ/í…œí”Œë¦¿ì€ ìœ ì§€ë©ë‹ˆë‹¤)')) return;
  await db.ref(`history/${hostKey}/${code}`).remove();
  refreshUnifiedHistory();
}

async function deleteSaved(kind, id){
  if(!FIREBASE_READY || !hostKey) return;
  const label = (kind==='archives')?'ì•„ì¹´ì´ë¸Œ':'í…œí”Œë¦¿';
  if(!confirm(`${label}ë¥¼ ì‚­ì œí• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ì–´ìš”)`)) return;
  await db.ref(`${kind}/${hostKey}/${id}`).remove();
  refreshUnifiedHistory();
}

/* ---------------- Unified list (Firebase + Local) ---------------- */
function openUnifiedHistory(){
  const ov = document.getElementById('unifiedHistoryOverlay');
  if(ov) ov.style.display = 'flex';
  setHistFilter('all');
  refreshUnifiedHistory();
}

function closeUnifiedHistory(){
  const ov = document.getElementById('unifiedHistoryOverlay');
  if(ov) ov.style.display = 'none';
}

function setHistFilter(f){
  histFilter = f || 'all';
  ['all','fav','live','archive','template'].forEach(k=>{
    document.getElementById('flt-'+(k==='archive'?'arc':k==='template'?'tpl':k==='fav'?'fav':k))?.classList.toggle('primary', histFilter===k);
  });
  refreshUnifiedHistory();
}

async function fetchFirebaseItems(){
  if(!FIREBASE_READY || !hostKey) return {history:[], archives:[], templates:[]};

  const [hs, as, ts] = await Promise.all([
    db.ref(`history/${hostKey}`).once('value'),
    db.ref(`archives/${hostKey}`).once('value'),
    db.ref(`templatesSaved/${hostKey}`).once('value')
  ]);

  const historyObj = hs.val() || {};
  const archObj = as.val() || {};
  const tplObj  = ts.val() || {};

  const history = Object.values(historyObj).map(v=>({type:'live', ...v}));
  const archives = Object.entries(archObj).map(([id,v])=>({type:'archive', id, ...v}));
  const templates = Object.entries(tplObj).map(([id,v])=>({type:'template', id, ...v}));

  return {history, archives, templates};
}

function mergeLocalIntoUnified(localArr, firebaseHistory){
  const map = new Map();
  // firebase first
  firebaseHistory.forEach(it=>{
    if(it && it.code) map.set(it.code, it);
  });
  // local as fallback
  localArr.forEach(it=>{
    if(!it || !it.code) return;
    if(!map.has(it.code)){
      map.set(it.code, {type:'local', ...it});
    }
  });
  return Array.from(map.values());
}

function applyFilter(items){
  let out = items;
  if(histFilter==='fav') out = out.filter(x=>x.favorite);
  if(histFilter==='live') out = out.filter(x=>x.type==='live' || x.type==='local');
  if(histFilter==='archive') out = out.filter(x=>x.type==='archive');
  if(histFilter==='template') out = out.filter(x=>x.type==='template');
  return out;
}

function sortItems(items){
  return items.sort((a,b)=>{
    const ta = a.savedAt || a.lastUsedAt || a.createdAt || 0;
    const tb = b.savedAt || b.lastUsedAt || b.createdAt || 0;
    return tb - ta;
  });
}

async function refreshUnifiedHistory(){
  const list = document.getElementById('unifiedHistoryList');
  if(!list) return;

  list.innerHTML = `<div style="padding:12px;color:var(--muted);font-weight:900;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>`;

  const localArr = getLocalHistory();
  let firebase = {history:[], archives:[], templates:[]};
  try{
    firebase = await fetchFirebaseItems();
  }catch(e){
    console.warn(e);
  }

  const unifiedLive = mergeLocalIntoUnified(localArr, firebase.history);
  let items = [...unifiedLive, ...firebase.archives, ...firebase.templates];
  items = applyFilter(items);
  items = sortItems(items);

  if(items.length===0){
    const msg = (!hostKey) ?
      'ê´€ë¦¬ì íˆìŠ¤í† ë¦¬ë¥¼ ë³´ë ¤ë©´ ê´€ë¦¬ì ë§í¬ë¡œ ì ‘ì†í•˜ê±°ë‚˜(ìë™ ë³µêµ¬) ì„¸ì…˜ì„ í•œ ë²ˆ ë§Œë“¤ì–´ ì£¼ì„¸ìš”.' :
      'ì €ì¥ëœ í•­ëª©ì´ ì—†ì–´ìš”.';
    list.innerHTML = `<div style="padding:14px;border:1px dashed var(--border);border-radius:16px;color:var(--muted);font-weight:900;">${msg}</div>`;
    return;
  }

  list.innerHTML = items.map(it=>{
    const ctxLabel = (window.ctxConfig && it.ctx && ctxConfig[it.ctx]) ? ctxConfig[it.ctx].label : (it.ctx||'');
    const title = it.title ? ` Â· ${escapeHtml(it.title)}` : '';
    const fav = it.favorite ? `<span class="badge fav">â˜…</span>` : '';
    const badge = it.type==='archive' ? `<span class="badge">ì•„ì¹´ì´ë¸Œ</span>` :
                  it.type==='template' ? `<span class="badge">í…œí”Œë¦¿</span>` :
                  it.type==='local' ? `<span class="badge">ë¡œì»¬</span>` :
                  `<span class="badge">ì„¸ì…˜</span>`;

    const when = fmtLocal(it.savedAt || it.lastUsedAt || it.createdAt || Date.now());
    const code = it.code || it.sourceRoom || 'â€”';

    // Actions
    let actions = '';
    if(it.type==='archive' || it.type==='template'){
      const kind = it.type==='archive' ? 'archives' : 'templatesSaved';
      actions = `
        <button class="small-btn primary" onclick="loadSavedItem('${it.id}')">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="small-btn" onclick="toggleSavedFav('${kind}','${it.id}')">â˜…</button>
        <button class="small-btn" onclick="renameSaved('${kind}','${it.id}')">ì´ë¦„</button>
        <button class="small-btn danger" onclick="deleteSaved('${kind}','${it.id}')">ì‚­ì œ</button>
      `;
    } else {
      actions = `
        <button class="small-btn primary" onclick="openUrl('${it.adminUrl || ''}')">ê´€ë¦¬ì</button>
        <button class="small-btn" onclick="copyText('${it.joinUrl || ''}')">ì°¸ì—¬ ë§í¬</button>
        ${hostKey ? `<button class="small-btn" onclick="toggleFirebaseFav('${it.code}')">â˜…</button>` : `<button class="small-btn" onclick="toggleLocalFav('${it.code}')">â˜…</button>`}
        ${hostKey ? `<button class="small-btn" onclick="renameFirebaseHistory('${it.code}')">ì´ë¦„</button>` : ''}
        ${hostKey ? `<button class="small-btn danger" onclick="deleteFirebaseHistory('${it.code}')">ì‚­ì œ</button>` : ''}
      `;
    }

    return `
      <div class="hist-item">
        <div class="hist-meta">
          <div class="hist-code">${fav}${badge}${escapeHtml(code)}${ctxLabel?` Â· ${ctxLabel}`:''}${title}</div>
          <div class="hist-time">${when}</div>
        </div>
        <div class="hist-actions">${actions}</div>
      </div>
    `;
  }).join('');
}

/* Saved items (archive/template) metadata ops */
async function toggleSavedFav(kind, id){
  if(!FIREBASE_READY || !hostKey) return alert('ê´€ë¦¬ì íˆìŠ¤í† ë¦¬ëŠ” ê´€ë¦¬ì ë§í¬ë¡œ ì ‘ì† í›„ ì‚¬ìš© ê°€ëŠ¥í•´ìš”.');
  const ref = db.ref(`${kind}/${hostKey}/${id}/favorite`);
  const cur = (await ref.once('value')).val();
  await ref.set(!cur);
  refreshUnifiedHistory();
}

async function renameSaved(kind, id){
  if(!FIREBASE_READY || !hostKey) return;
  const ref = db.ref(`${kind}/${hostKey}/${id}/title`);
  const cur = (await ref.once('value')).val() || '';
  const next = prompt('ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”:', cur);
  if(next === null) return;
  await ref.set(next.trim());
  refreshUnifiedHistory();
}

/* Initialize landing widgets */
setTimeout(()=>{ selectCtx(selectedCtx); renderLocalHistory(); }, 60);


/* ============================================================
   Participant nickname tracking (for host view)
============================================================ */
let clientId = (function(){
  try{
    const k='actively_client_id';
    let v = localStorage.getItem(k);
    if(!v){
      // short random id
      v = (Math.random().toString(36).slice(2,10) + Math.random().toString(36).slice(2,10)).slice(0,12);
      localStorage.setItem(k, v);
    }
    return v;
  }catch(e){ return 'anon_'+Math.random().toString(36).slice(2,10); }
})();

let participantNames = {}; // {clientId: nickname}

function renderParticipantNames(){
  const wrap = document.getElementById('participantNamesList');
  const lbl = document.getElementById('participantCountLabel');
  if(!wrap || !lbl) return;
  const names = Object.values(participantNames||{}).filter(Boolean);
  lbl.textContent = `${names.length}ëª…`;
  if(names.length===0){
    wrap.innerHTML = `<div style="color:var(--muted);font-weight:850;font-size:12px;">ì•„ì§ ì°¸ì—¬ìê°€ ì—†ì–´ìš”.</div>`;
    return;
  }
  wrap.innerHTML = names.slice(0,80).map(n=>`
    <span style="border:1px solid var(--border);background:var(--off);padding:7px 10px;border-radius:999px;font-weight:950;font-size:12px;">
      ${escapeHtml(n)}
    </span>
  `).join('');
}

async function attachParticipantNickname(code, nickname){
  try{
    if(!FIREBASE_READY || !code) return;
    if(!nickname) return;
    const ref = db.ref(`sessions/${code}/nicknames/${clientId}`);
    await ref.set(String(nickname).slice(0,24));
    ref.onDisconnect().remove();
  }catch(e){ console.warn(e); }
}


/* ============================================================
   Host: participant advanced (sort/duplicate/kick/log) + Title
   Participant: always-on Q&A + kick listener
============================================================ */
let participantSortMode = 'join'; // 'join' | 'alpha'
let participantsMeta = {}; // {clientId: {nickname, joinedAt}}
let kicked = false;

function setParticipantSort(mode){
  participantSortMode = mode || 'join';
  document.getElementById('sort-join')?.classList.toggle('primary', participantSortMode==='join');
  document.getElementById('sort-alpha')?.classList.toggle('primary', participantSortMode==='alpha');
  renderParticipantNames();
}

function normalizeNickname(name){
  return String(name||'').trim().slice(0,24);
}

async function registerParticipantMeta(code, nickname){
  if(!FIREBASE_READY || !code) return;
  const nick = normalizeNickname(nickname);
  if(!nick) return;

  // Deduplicate nickname: "name", "name(2)", "name(3)"
  try{
    const snap = await db.ref(`sessions/${code}/participantsMeta`).once('value');
    const obj = snap.val() || {};
    const existingNames = new Set(Object.values(obj).map(v => (v && v.nickname) ? String(v.nickname) : '').filter(Boolean));
    let finalName = nick;
    if(existingNames.has(finalName)){
      let i=2;
      while(existingNames.has(`${nick}(${i})`)) i++;
      finalName = `${nick}(${i})`;
    }
    await db.ref(`sessions/${code}/participantsMeta/${clientId}`).set({nickname: finalName, joinedAt: Date.now()});
    await db.ref(`sessions/${code}/nicknames/${clientId}`).set(finalName); // keep legacy
    db.ref(`sessions/${code}/participantsMeta/${clientId}`).onDisconnect().remove();
    db.ref(`sessions/${code}/nicknames/${clientId}`).onDisconnect().remove();
  }catch(e){
    console.warn(e);
    // fallback
    await db.ref(`sessions/${code}/participantsMeta/${clientId}`).set({nickname: nick, joinedAt: Date.now()});
    await db.ref(`sessions/${code}/nicknames/${clientId}`).set(nick);
  }
}

function renderParticipantNames(){
  const wrap = document.getElementById('participantNamesList');
  const lbl = document.getElementById('participantCountLabel');
  if(!wrap) return;

  const entries = Object.entries(participantsMeta||{}).map(([id,v])=>({id, ...(v||{})}));
  let list = entries.filter(x=>x.nickname);

  if(participantSortMode==='alpha'){
    list.sort((a,b)=> String(a.nickname).localeCompare(String(b.nickname), 'ko'));
  }else{
    list.sort((a,b)=> (a.joinedAt||0) - (b.joinedAt||0));
  }

  if(lbl) lbl.textContent = `${list.length}ëª…`;

  if(list.length===0){
    wrap.innerHTML = `<div style="color:var(--muted);font-weight:850;font-size:12px;">ì•„ì§ ì°¸ì—¬ìê°€ ì—†ì–´ìš”.</div>`;
    return;
  }

  wrap.innerHTML = list.slice(0,120).map(p=>`
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid var(--border);background:var(--off);padding:10px 12px;border-radius:14px;">
      <div style="font-weight:950;font-size:13px;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(p.nickname)}</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
        <button class="small-btn" onclick="copyText('${p.nickname}')">ë³µì‚¬</button>
        <button class="small-btn danger" onclick="kickParticipant('${p.id}','${escapeHtml(p.nickname).replaceAll("'", "\\'")}')">í‡´ì¥</button>
      </div>
    </div>
  `).join('');
}

async function kickParticipant(id, nickname){
  if(!isHost){ alert('ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.'); return; }
  if(!FIREBASE_READY || !roomCode) return;
  if(!confirm(`"${nickname||'ì°¸ì—¬ì'}" ë‹˜ì„ í‡´ì¥ì‹œí‚¬ê¹Œìš”?`)) return;
  await db.ref(`sessions/${roomCode}/kicks/${id}`).set({at: Date.now()});
  await db.ref(`sessions/${roomCode}/participantsMeta/${id}`).remove();
  await db.ref(`sessions/${roomCode}/nicknames/${id}`).remove();
  addFeed(`ì°¸ì—¬ì í‡´ì¥: ${nickname||id}`, 'var(--theme-a)');
}

async function kickAllParticipants(){
  if(!isHost){ alert('ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.'); return; }
  if(!FIREBASE_READY || !roomCode) return;
  if(!confirm('ì „ì²´ ì°¸ì—¬ìë¥¼ í‡´ì¥ì‹œí‚¬ê¹Œìš”?')) return;
  const ids = Object.keys(participantsMeta||{});
  const updates = {};
  const ts = Date.now();
  ids.forEach(id=>{ updates[`sessions/${roomCode}/kicks/${id}`] = {at: ts}; });
  updates[`sessions/${roomCode}/participantsMeta`] = null;
  updates[`sessions/${roomCode}/nicknames`] = null;
  await db.ref().update(updates);
  addFeed('ì „ì²´ í‡´ì¥ ì‹¤í–‰', 'var(--theme-a)');
}

/* Host wiring: join/leave logs from participantsMeta */
function attachParticipantMetaListeners(){
  if(!FIREBASE_READY || !roomCode) return;
  fbOn('participantsMeta','value', s=>{ participantsMeta = s.val()||{}; renderParticipantNames(); });
  fbOn('participantsMeta','child_added', s=>{
    const v = s.val()||{};
    if(v.nickname) addFeed(`ì…ì¥: ${v.nickname}`, 'var(--theme-g)');
  });
  fbOn('participantsMeta','child_removed', s=>{
    const v = s.val()||{};
    if(v.nickname) addFeed(`í‡´ì¥: ${v.nickname}`, 'var(--muted)');
  });
}

/* Participant: kick listener */
function attachKickListener(){
  if(!FIREBASE_READY || !roomCode) return;
  const ref = db.ref(`sessions/${roomCode}/kicks/${clientId}`);
  ref.on('value', snap=>{
    if(snap.exists() && !kicked){
      kicked = true;
      try{ alert('ë°œí‘œìê°€ í‡´ì¥ì‹œì¼°ì–´ìš”.'); }catch(e){}
      fbOffAll();
      showScreen('landing');
    }
  });
}

/* Participant: always-on Q&A */
function showQAFab(show){
  const btn = document.getElementById('qaFab');
  if(btn) btn.style.display = show ? 'block' : 'none';
}
function openParticipantQAModal(){
  if(!roomCode){ alert('ì„¸ì…˜ì— ì°¸ì—¬ ì¤‘ì´ ì•„ë‹ˆì—ìš”.'); return; }
  const m = document.getElementById('qaModal');
  if(m) m.style.display = 'flex';
  setTimeout(()=>document.getElementById('qaModalInput')?.focus(), 50);
}
function closeParticipantQAModal(){
  const m = document.getElementById('qaModal');
  if(m) m.style.display = 'none';
}
async function submitParticipantQA(){
  if(!FIREBASE_READY || !roomCode){ alert('ì—°ê²°ì´ í•„ìš”í•´ìš”.'); return; }
  const txt = (document.getElementById('qaModalInput')?.value||'').trim();
  if(!txt){ alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
  const payload = { q: txt, nick: nickname || 'ìµëª…', ts: Date.now(), votes: 0 };
  await db.ref(`sessions/${roomCode}/qa`).push(payload);
  document.getElementById('qaModalInput').value = '';
  closeParticipantQAModal();
  try{ alert('ì§ˆë¬¸ì„ ë³´ëƒˆì–´ìš”!'); }catch(e){}
}

/* Title in top bar */
function setTopTitle(t){
  const el = document.getElementById('sessionTitleTop');
  const banner = document.getElementById('hostTitleBanner');
  const title = (t||'').toString().trim();
  if(el) el.textContent = title;
  if(banner) banner.style.display = title ? 'flex' : 'none';
}

/* Hook: when host session loads from DB, set title */
(async function patchTitleOnLoad(){
  try{
    // try read title when roomCode exists and host
    if(FIREBASE_READY && isHost && roomCode){
      const snap = await db.ref(`sessions/${roomCode}/title`).once('value');
      setTopTitle(snap.val()||sessionTitle||'');
    }
  }catch(e){}
})();


/* ============================================================
   Participant: Always-on Q&A (C: ìµëª… ì˜µì…˜) + session title
============================================================ */
function setParticipantSessionTitle(t){
  const el = document.getElementById('pSessionTitleHead');
  if(!el) return;
  const title = (t||'').toString().trim();
  el.textContent = title ? `Â· ${title}` : '';
}

async function submitQuickQA(){
  if(!roomCode){ alert('ì„¸ì…˜ì— ë¨¼ì € ì°¸ì—¬í•´ ì£¼ì„¸ìš”.'); return; }
  const input = document.getElementById('qaQuickInput');
  const anon = document.getElementById('qaAnonToggle')?.checked;
  const txt = (input?.value||'').trim();
  if(!txt){ alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
  const nickToSend = anon ? 'ìµëª…' : (nickname || 'ìµëª…');
  const payload = { q: txt, nick: nickToSend, ts: Date.now(), votes: 0 };

  if(!FIREBASE_READY || !db){
    // Demo/offline fallback: store locally so user doesn't feel blocked
    try{
      const key = 'actively_local_qa_'+roomCode;
      const arr = JSON.parse(localStorage.getItem(key)||'[]');
      arr.push(payload);
      localStorage.setItem(key, JSON.stringify(arr.slice(-50)));
    }catch(e){}
    if(input) input.value='';
    try{ alert('ë°ëª¨ ëª¨ë“œë¼ ì´ ê¸°ê¸°ì—ì„œë§Œ ì €ì¥ëì–´ìš”. (Firebase ì—°ê²° ì‹œ ì‹¤ì‹œê°„ ì „ì†¡)'); }catch(e){}
    return;
  }

  await db.ref(`sessions/${roomCode}/qa`).push(payload);
  if(input) input.value='';
  try{ alert('ì§ˆë¬¸ì„ ë³´ëƒˆì–´ìš”!'); }catch(e){}
}



// ==========================================
// ğŸš€ ê³ ìˆ˜ì˜ ì¶”ê°€ ì—…ë°ì´íŠ¸ ë¡œì§ (íœ˜ë°œì„± ë°©ì§€ & í”¼ë“œ)
// ==========================================

// 1. ìƒíƒœ ì €ì¥ í•¨ìˆ˜ (ë¸Œë¼ìš°ì € ë¡œì»¬ ì €ì¥ì†Œ í™œìš©)
function saveAppState() {
    const state = {
        uiMode: document.body.className,
        // í˜„ì¬ ì„ íƒëœ í…Œë§ˆ ìƒ‰ìƒ(CSS ë³€ìˆ˜) ì €ì¥
        themeA: document.documentElement.style.getPropertyValue('--theme-a')
    };
    localStorage.setItem('actively_state', JSON.stringify(state));
}

// 2. ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ (í˜ì´ì§€ ì—´ ë•Œ ìë™ ì‹¤í–‰)
function loadAppState() {
    const saved = localStorage.getItem('actively_state');
    if (saved) {
        const state = JSON.parse(saved);
        if (state.uiMode) document.body.className = state.uiMode;
        if (state.themeA) document.documentElement.style.setPropertyValue('--theme-a', state.themeA);
    }
}

// 3. ì‹¤ì‹œê°„ í”¼ë“œ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
function addLiveFeedMessage(message, type = 'info') {
    const feedContainer = document.querySelector('.live-feed');
    if (!feedContainer) return;

    const now = new Date();
    const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
    
    const item = document.createElement('div');
    item.className = 'feed-item new-entry';
    item.innerHTML = `
        <div class="feed-dot" style="background: ${type === 'join' ? '#22a05a' : 'var(--theme-a)'}"></div>
        <div class="feed-txt">${message}</div>
        <div class="feed-time">${timeStr}</div>
    `;
    
    feedContainer.prepend(item);
    setTimeout(() => { item.classList.remove('new-entry'); }, 3000);
}

// 4. ê¸°ì¡´ UI ë³€ê²½ ë²„íŠ¼ë“¤ì— ì €ì¥ ê¸°ëŠ¥ ê°•ì œ ì—°ê²°
document.querySelectorAll('[onclick*="ui-"]').forEach(btn => {
    btn.addEventListener('click', () => {
        setTimeout(saveAppState, 100); // UI ë³€ê²½ í›„ ì €ì¥
    });
});

// ì‹¤í–‰
window.addEventListener('load', loadAppState);


</script>

  <!-- ê´€ë¦¬ì PIN ì…ë ¥ -->
  <div id="adminPinOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:300;">
    <div style="background:white;padding:28px;border-radius:20px;width:320px;text-align:center;">
      <h3 style="margin-bottom:12px;">ê´€ë¦¬ì ì¸ì¦</h3>
      <input id="adminPinInput" type="password" placeholder="ê´€ë¦¬ì PIN ì…ë ¥"
        style="width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-bottom:14px;" />
      <button onclick="verifyAdminPin()"
        style="padding:10px 16px;border:none;border-radius:12px;background:#111;color:white;font-weight:700;cursor:pointer;">
        í™•ì¸
      </button>
    </div>
  </div>


  <!-- â”€â”€ ì €ì¥ëœ ì„¸ì…˜/í…œí”Œë¦¿ ì˜¤ë²„ë ˆì´ â”€â”€ -->
  <div id="savedOverlay" style="position:fixed;inset:0;background:rgba(10,12,16,0.55);backdrop-filter:blur(6px);z-index:220;display:none;align-items:center;justify-content:center;padding:24px;">
    <div style="background:var(--surface-card);border:1px solid var(--border);border-radius:24px;max-width:680px;width:100%;box-shadow:0 20px 70px rgba(0,0,0,0.25);overflow:hidden;">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--border);">
        <div>
          <div id="savedTitle" style="font-weight:900;letter-spacing:-0.02em;">ì €ì¥ëœ í•­ëª©</div>
          <div style="font-size:12px;color:var(--muted);margin-top:2px;">ë¶ˆëŸ¬ì˜¤ë©´ ìƒˆ ì„¸ì…˜ìœ¼ë¡œ ë³µì œë©ë‹ˆë‹¤ (ê¸°ì¡´ ì„¸ì…˜ì€ ìœ ì§€).</div>
        </div>
        <button onclick="closeSavedOverlay()" style="border:1px solid var(--border);background:var(--off);border-radius:12px;padding:8px 10px;font-weight:800;cursor:pointer;">ë‹«ê¸° âœ•</button>
      </div>

      <div style="padding:14px 18px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
        <div style="font-size:12px;color:var(--muted);font-weight:700;">ì •ë ¬:</div>
        <button onclick="refreshSavedList()" style="border:1px solid var(--border);background:var(--surface);border-radius:12px;padding:8px 10px;font-weight:800;cursor:pointer;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        <div style="flex:1;"></div>
        <button onclick="saveCurrentAs('archives')" style="border:none;background:var(--theme-g);color:#fff;border-radius:12px;padding:9px 12px;font-weight:900;cursor:pointer;">ğŸ’¾ ì„¸ì…˜ ì €ì¥</button>
        <button onclick="saveCurrentAs('templatesSaved')" style="border:none;background:var(--theme-a);color:#fff;border-radius:12px;padding:9px 12px;font-weight:900;cursor:pointer;">ğŸ“¦ í…œí”Œë¦¿ ì €ì¥</button>
      </div>

      <div id="savedList" style="padding:6px 18px 18px;max-height:55vh;overflow:auto;"></div>
    </div>
  </div>


<!-- â”€â”€ í†µí•© íˆìŠ¤í† ë¦¬ ì˜¤ë²„ë ˆì´ (ì„¸ì…˜/ì•„ì¹´ì´ë¸Œ/í…œí”Œë¦¿) â”€â”€ -->
<div id="unifiedHistoryOverlay" style="position:fixed;inset:0;background:rgba(10,12,16,0.55);backdrop-filter:blur(6px);z-index:250;display:none;align-items:center;justify-content:center;padding:18px;">
  <div style="background:var(--surface-card);border:1px solid var(--border);border-radius:24px;max-width:820px;width:100%;box-shadow:0 20px 70px rgba(0,0,0,0.25);overflow:hidden;">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--border);gap:10px;">
      <div>
        <div style="font-weight:950;letter-spacing:-0.02em;">ğŸ—‚ í†µí•© íˆìŠ¤í† ë¦¬</div>
        <div style="font-size:12px;color:var(--muted);margin-top:2px;font-weight:800;">ì„¸ì…˜/ì•„ì¹´ì´ë¸Œ/í…œí”Œë¦¿ì„ í•œ ê³³ì—ì„œ ê´€ë¦¬í•´ìš”.</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end;">
        <button onclick="refreshUnifiedHistory()" style="border:1px solid var(--border);background:var(--surface);border-radius:12px;padding:8px 10px;font-weight:900;cursor:pointer;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        <button onclick="closeUnifiedHistory()" style="border:1px solid var(--border);background:var(--off);border-radius:12px;padding:8px 10px;font-weight:900;cursor:pointer;">ë‹«ê¸° âœ•</button>
      </div>
    </div>

    <div style="padding:12px 18px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;border-bottom:1px solid var(--border);">
      <div style="font-size:12px;color:var(--muted);font-weight:900;">í•„í„°:</div>
      <button class="small-btn" id="flt-all" onclick="setHistFilter('all')">ì „ì²´</button>
      <button class="small-btn" id="flt-fav" onclick="setHistFilter('fav')">â˜… ì¦ê²¨ì°¾ê¸°</button>
      <button class="small-btn" id="flt-live" onclick="setHistFilter('live')">ì„¸ì…˜</button>
      <button class="small-btn" id="flt-arc" onclick="setHistFilter('archive')">ì•„ì¹´ì´ë¸Œ</button>
      <button class="small-btn" id="flt-tpl" onclick="setHistFilter('template')">í…œí”Œë¦¿</button>
      <div style="flex:1;"></div>
      <button onclick="saveCurrentAs('archives')" style="border:none;background:var(--theme-g);color:#fff;border-radius:12px;padding:9px 12px;font-weight:950;cursor:pointer;">ğŸ’¾ ì„¸ì…˜ ì €ì¥</button>
      <button onclick="saveCurrentAs('templatesSaved')" style="border:none;background:var(--theme-a);color:#fff;border-radius:12px;padding:9px 12px;font-weight:950;cursor:pointer;">ğŸ“¦ í…œí”Œë¦¿ ì €ì¥</button>
    </div>

    <div id="unifiedHistoryList" style="padding:6px 18px 18px;max-height:60vh;overflow:auto;"></div>
  </div>
</div>


  <!-- ì°¸ì—¬ì: ì–¸ì œë“  Q&A -->
  <button id="qaFab" onclick="openParticipantQAModal()" style="position:fixed;right:16px;bottom:16px;z-index:240;display:none;border:none;background:var(--theme-a);color:#fff;border-radius:999px;padding:12px 14px;font-weight:950;box-shadow:0 14px 40px rgba(0,0,0,.25);cursor:pointer;">
    ğŸ’¬ Q&A
  </button>

  <div id="qaModal" style="position:fixed;inset:0;background:rgba(10,12,16,.55);backdrop-filter:blur(6px);z-index:260;display:none;align-items:center;justify-content:center;padding:18px;">
    <div style="background:var(--surface-card);border:1px solid var(--border);border-radius:22px;max-width:520px;width:100%;overflow:hidden;">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);">
        <div style="font-weight:950;">ğŸ’¬ ì§ˆë¬¸í•˜ê¸°</div>
        <button class="small-btn" onclick="closeParticipantQAModal()">ë‹«ê¸° âœ•</button>
      </div>
      <div style="padding:14px 16px;">
        <div style="font-size:12px;color:var(--muted);font-weight:900;margin-bottom:8px;">ì–¸ì œë“  ì§ˆë¬¸ì„ ë‚¨ê¸¸ ìˆ˜ ìˆì–´ìš”. ë°œí‘œìì—ê²Œ ë°”ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.</div>
        <textarea id="qaModalInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš” (ìµëª… ê°€ëŠ¥)" style="width:100%;min-height:110px;resize:vertical;padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:var(--surface);font-family:var(--font);font-weight:850;outline:none;"></textarea>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px;">
          <button class="small-btn" onclick="closeParticipantQAModal()">ì·¨ì†Œ</button>
          <button class="small-btn primary" onclick="submitParticipantQA()">ë³´ë‚´ê¸°</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
